<!doctype html><html lang=en><head><title>ECW CTF 2021: Pipe Dream (Writeup) ::
face0xff's den</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="From October 8th to October 24th took place the online qualification round for the European Cyber Week CTF Finals, that are held every year in Rennes, France.
I had the opportunity to create a challenge for this event as part of my internship at Thalium. This was the first time I actually publish a challenge and I hope those who gave it a try enjoyed it.
This writeup is of course not meant to convey the perspective of a player, but rather aims to be an explanation of the task and my thoughts as its author.
"><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=/posts/ecw-ctf-2021-pipe-dream-writeup/><link rel=stylesheet href=/assets/style.css><link rel=stylesheet href=/style.css><link rel=apple-touch-icon-precomposed sizes=144x144 href=/img/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=/img/favicon.png><link href=/assets/fonts/Inter-Italic.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=/assets/fonts/Inter-Regular.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=/assets/fonts/Inter-Medium.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=/assets/fonts/Inter-MediumItalic.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=/assets/fonts/Inter-Bold.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=/assets/fonts/Inter-BoldItalic.woff2 rel=preload type=font/woff2 as=font crossorigin><meta name=twitter:card content="summary"><meta name=twitter:title content="ECW CTF 2021: Pipe Dream (Writeup)"><meta name=twitter:description content="From October 8th to October 24th took place the online qualification round for the European Cyber Week CTF Finals, that are held every year in Rennes, France. I had the opportunity to create a reverse engineering challenge for this event as part of an internship at Thalium."><meta property="og:url" content="/posts/ecw-ctf-2021-pipe-dream-writeup/"><meta property="og:site_name" content="face0xff's den"><meta property="og:title" content="ECW CTF 2021: Pipe Dream (Writeup)"><meta property="og:description" content="From October 8th to October 24th took place the online qualification round for the European Cyber Week CTF Finals, that are held every year in Rennes, France. I had the opportunity to create a reverse engineering challenge for this event as part of an internship at Thalium."><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-10-24T00:00:00+00:00"><meta property="article:modified_time" content="2021-10-24T00:00:00+00:00"><link rel=stylesheet href=/css/custom.css><script>MathJax={tex:{inlineMath:[["$","$"],["\\(","\\)"]],displayMath:[["$$","$$"],["\\[","\\]"]],processEscapes:!0,processEnvironments:!0},options:{skipHtmlTags:["script","noscript","style","textarea","pre"]}},window.addEventListener("load",e=>{document.querySelectorAll("mjx-container").forEach(function(e){e.parentElement.classList+="has-jax"})})</script><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script type=text/javascript id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script></head><body><div class=container><header class=header><span class=header__inner><a href=/ class=logo style=text-decoration:none><span class=logo__mark><svg class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg>
</span><span class=logo__text>face@0xff</span>
<span class=logo__cursor></span>
</a><span class=header__right><nav class=menu><ul class="menu__inner menu__inner--desktop"><li><a href=/about>About</a></li><li><a href=https://ctf.0xff.re/ target=_blank>Writeups</a></li><li><a href=/research>Research</a></li><li><a href=/challenges>Challenges</a></li></ul><ul class="menu__inner menu__inner--mobile"><li><a href=/about>About</a></li><li><a href=https://ctf.0xff.re/ target=_blank>Writeups</a></li><li><a href=/research>Research</a></li><li><a href=/challenges>Challenges</a></li></ul></nav><span class=menu-trigger><svg viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></span></span></span></header><div class=content><div class=post><h1 class=post-title>ECW CTF 2021: Pipe Dream (Writeup)</h1><div class=post-meta><span class=post-date>2021-10-24</span></div><div class=post-content><p>From October 8th to October 24th took place the <strong>online qualification round for the European Cyber Week CTF Finals</strong>, that are held every year in Rennes, France.</p><p>I had the opportunity to <strong>create a challenge</strong> for this event as part of my internship at Thalium. This was the first time I actually publish a challenge and I hope those who gave it a try enjoyed it.</p><p>This writeup is of course not meant to convey the perspective of a player, but rather aims to be an explanation of the task and my thoughts as its author.</p><ul><li><a href=/posts/ecw-ctf-2021-pipe-dream-writeup/#getting-started>Getting started</a></li><li><a href=/posts/ecw-ctf-2021-pipe-dream-writeup/#understanding-the-big-picture>Understanding the big picture</a></li><li><a href=/posts/ecw-ctf-2021-pipe-dream-writeup/#reversing-the-protocol>Reversing the protocol</a></li><li><a href=/posts/ecw-ctf-2021-pipe-dream-writeup/#puzzle-state-machine>Puzzle state machine</a></li><li><a href=/posts/ecw-ctf-2021-pipe-dream-writeup/#writing-a-keygen>Writing a keygen</a></li><li><a href=/posts/ecw-ctf-2021-pipe-dream-writeup/#against-the-remote>Against the remote</a><ul><li><a href=/posts/ecw-ctf-2021-pipe-dream-writeup/#first-step>First step</a></li><li><a href=/posts/ecw-ctf-2021-pipe-dream-writeup/#a-little-twist>A little twist</a></li></ul></li><li><a href=/posts/ecw-ctf-2021-pipe-dream-writeup/#conclusion>Conclusion</a></li><li><a href=/posts/ecw-ctf-2021-pipe-dream-writeup/#full-source-code>Full source code</a></li></ul><h2 id=getting-started>Getting started</h2><p><em>Pipe Dream</em> is a classic <strong>Linux x86 reverse engineering challenge</strong> on the medium-harder side of the difficulty spectrum. It was solved by only one contestant (at least <em>officially</em>), making it the least solved reverse challenge of the event, and the least solved challenge overall.</p><p>You can download it here: <a href=/img/pipedream/pipedream>pipedream</a>.</p><blockquote><p><em>A group of hackers have taken over our hospital. They installed a backdoor; we have located it, but it has an authentication system. Help us defeat their system!</em></p><p>This binary asks for a username and a serial key. Implement a keygen and try it online (through VPN) at <code>tcp://10.4.0.12:42000</code></p></blockquote><p>From the description, we learn that we got our hands on a <strong>keygen</strong> crackme. The online validation service will probably ask us to generate valid keys for given usernames or something.</p><p>Let&rsquo;s run the binary and see what it&rsquo;s about:</p><pre tabindex=0><code>$ ./pipedream  
Enter username: abc
Enter serial: def
Not even close. Bye!
[1]    14830 killed     ./pipedream
</code></pre><p>The binary does not seem to exit the normal way&mldr; It seems like a process has been killed by one another.</p><pre tabindex=0><code>$ ./pipedream
Enter username: abc
Enter serial: ABCD
You lost your path and fell into lava. It hurts and you die.
I lost my child :(
[1]    14998 killed     ./pipedream

$ ./pipedream
Enter username: abc
Enter serial: 00
You lost your path already?
I lost my child :(
[1]    15309 killed     ./pipedream
</code></pre><p>Okay, what the heck? Without further ado, let&rsquo;s fire up IDA.</p><p>The binary does not seem obfuscated and the code looks relatively nice; it was probably written in C. We immediately locate the <strong>main function</strong> (<code>sub_343D</code>) that, among other things, asks for user input.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>v6 <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>v14[<span style=color:#ae81ff>0</span>] <span style=color:#f92672>=</span> <span style=color:#ae81ff>0x706050403020100LL</span>;
</span></span><span style=display:flex><span>v14[<span style=color:#ae81ff>1</span>] <span style=color:#f92672>=</span> <span style=color:#ae81ff>0xF0E0D0C0B0A0908LL</span>;
</span></span><span style=display:flex><span><span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;Enter username: &#34;</span>);
</span></span><span style=display:flex><span><span style=color:#a6e22e>__isoc99_scanf</span>(<span style=color:#e6db74>&#34;%511s&#34;</span>, username);
</span></span><span style=display:flex><span>v4 <span style=color:#f92672>=</span> <span style=color:#a6e22e>strlen</span>(username);
</span></span><span style=display:flex><span><span style=color:#a6e22e>sub_1477</span>(username, v4, <span style=color:#f92672>&amp;</span>v6);
</span></span><span style=display:flex><span><span style=color:#a6e22e>sub_1418</span>(v6);
</span></span><span style=display:flex><span><span style=color:#a6e22e>sub_1660</span>(v14, <span style=color:#ae81ff>16LL</span>);
</span></span><span style=display:flex><span><span style=color:#a6e22e>sub_16EA</span>();
</span></span></code></pre></div><p>Many functions are called after we input our username.</p><ul><li><code>sub_1477</code>: we can recognize it computes a <strong>CRC32</strong>, which we can verify dynamically. It does not use a fast lookup table, but we can notice the use of the polynomial <code>0xEDB88320</code>.</li><li><code>sub_1418</code> only takes the CRC sum and puts it in a static global variable (<code>dword_6010</code>).</li></ul><p>If we look for other references to this DWORD, we can see it is used in <code>sub_13E4</code> which is a mere <strong>linear congruential generator</strong> (<code>dword_6010 = 1103515245 * dword_6010 + 12345</code>). Therefore, <code>sub_13E4</code> must be some kind of <code>rand</code> function, and <code>sub_1418</code> an <code>srand</code> function.</p><p>The next function, <code>sub_1660</code>, takes <code>v14</code> and considers it as a 16-byte array (<code>0, 1, ..., 15</code>). It then performs severals swaps between randomly generated indexes. One can recognize a <strong>Fisher-Yates shuffle</strong>, which outputs here a random permutation of the integers between 0 and 15.</p><p>The fun starts inside the <code>sub_16EA</code> function.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>__int64</span> <span style=color:#a6e22e>sub_16EA</span>() {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>int</span> i; <span style=color:#75715e>// [rsp+Ch] [rbp-24h]
</span></span></span><span style=display:flex><span>  <span style=color:#66d9ef>int</span> j; <span style=color:#75715e>// [rsp+10h] [rbp-20h]
</span></span></span><span style=display:flex><span>  <span style=color:#66d9ef>int</span> k; <span style=color:#75715e>// [rsp+14h] [rbp-1Ch]
</span></span></span><span style=display:flex><span>  <span style=color:#66d9ef>int</span> l; <span style=color:#75715e>// [rsp+18h] [rbp-18h]
</span></span></span><span style=display:flex><span>  <span style=color:#66d9ef>int</span> m; <span style=color:#75715e>// [rsp+1Ch] [rbp-14h]
</span></span></span><span style=display:flex><span>  <span style=color:#66d9ef>int</span> pipedes[<span style=color:#ae81ff>2</span>]; <span style=color:#75715e>// [rsp+20h] [rbp-10h] BYREF
</span></span></span><span style=display:flex><span>  <span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>__int64</span> v7; <span style=color:#75715e>// [rsp+28h] [rbp-8h]
</span></span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  v7 <span style=color:#f92672>=</span> <span style=color:#a6e22e>__readfsqword</span>(<span style=color:#ae81ff>0x28u</span>);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>for</span> ( i <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; i <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>3</span>; <span style=color:#f92672>++</span>i ) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> ( j <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; j <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>3</span>; <span style=color:#f92672>++</span>j ) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>for</span> ( k <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; k <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>3</span>; <span style=color:#f92672>++</span>k ) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> ( l <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; l <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>3</span>; <span style=color:#f92672>++</span>l ) {
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>if</span> ( i <span style=color:#f92672>==</span> k <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>abs32</span>(j <span style=color:#f92672>-</span> l) <span style=color:#f92672>==</span> <span style=color:#ae81ff>1</span> <span style=color:#f92672>||</span> j <span style=color:#f92672>==</span> l <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>abs32</span>(i <span style=color:#f92672>-</span> k) <span style=color:#f92672>==</span> <span style=color:#ae81ff>1</span> ) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> ( <span style=color:#a6e22e>pipe</span>(pipedes) ) {
</span></span><span style=display:flex><span>              <span style=color:#a6e22e>puts</span>(<span style=color:#e6db74>&#34;pipe failed&#34;</span>);
</span></span><span style=display:flex><span>              <span style=color:#a6e22e>exit</span>(<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            dword_6060[<span style=color:#ae81ff>64</span> <span style=color:#f92672>*</span> i <span style=color:#f92672>+</span> <span style=color:#ae81ff>16</span> <span style=color:#f92672>*</span> j <span style=color:#f92672>+</span> <span style=color:#ae81ff>4</span> <span style=color:#f92672>*</span> k <span style=color:#f92672>+</span> l] <span style=color:#f92672>=</span> pipedes[<span style=color:#ae81ff>0</span>];
</span></span><span style=display:flex><span>            dword_6460[<span style=color:#ae81ff>64</span> <span style=color:#f92672>*</span> i <span style=color:#f92672>+</span> <span style=color:#ae81ff>16</span> <span style=color:#f92672>*</span> j <span style=color:#f92672>+</span> <span style=color:#ae81ff>4</span> <span style=color:#f92672>*</span> k <span style=color:#f92672>+</span> l] <span style=color:#f92672>=</span> pipedes[<span style=color:#ae81ff>1</span>];
</span></span><span style=display:flex><span>          }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>for</span> ( m <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; m <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>1</span>; <span style=color:#f92672>++</span>m ) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> ( <span style=color:#a6e22e>pipe</span>(pipedes) ) {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>puts</span>(<span style=color:#e6db74>&#34;pipe failed&#34;</span>);
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>exit</span>(<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        dword_6860[<span style=color:#ae81ff>16</span> <span style=color:#f92672>*</span> m <span style=color:#f92672>+</span> <span style=color:#ae81ff>4</span> <span style=color:#f92672>*</span> i <span style=color:#f92672>+</span> j] <span style=color:#f92672>=</span> pipedes[<span style=color:#ae81ff>0</span>];
</span></span><span style=display:flex><span>        dword_68E0[<span style=color:#ae81ff>16</span> <span style=color:#f92672>*</span> m <span style=color:#f92672>+</span> <span style=color:#ae81ff>4</span> <span style=color:#f92672>*</span> i <span style=color:#f92672>+</span> j] <span style=color:#f92672>=</span> pipedes[<span style=color:#ae81ff>1</span>];
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> v7 <span style=color:#f92672>-</span> <span style=color:#a6e22e>__readfsqword</span>(<span style=color:#ae81ff>0x28u</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>This function creates a bunch of <strong>pipes</strong> when certain conditions are met, and puts the pipes&rsquo; file descriptors inside several arrays.</p><p>The condition $((i = k) \land (\lvert j - l \rvert = 1)) \lor ((j = l) \land (\lvert i - k \rvert = 1))$ gives out a big clue. $(i, j)$ and $(k, l)$ probably represent coordinates on a $4 \times 4$ grid, and the condition checks whether <strong>two cells are adjacent</strong>.</p><p><code>dword_6060</code> and <code>dword_6460</code> are both global arrays of length 256, indexed by $64i + 16j + 4k + l$, a base 4 decomposition to identify the couple of cells $(i, j), (k, l)$. The first array receives the read end of the pipe, and the second array receives the write end.</p><p>By symmetry, a pipe is also created for the $(k, l), (i, j)$ couple. A potential intuition at this point is that each cell has a pipe&rsquo;s read end and a pipe&rsquo;s write end linked with all of its adjacent cells. In other words, each cell can read from an adjacent cell and write to an adjacent cell; they can communicate in some bi-directional way.</p><img src=/img/pipedream/diagram1.png style="margin:0 auto;margin-top:2em;margin-bottom:2em" alt="Communicating cells?"><p>There are also two other global arrays, <code>dword_6860</code> and <code>dword_68E0</code>, of length 32. These store the read and write ends of two pipes associated with a cell $(i, j)$. We&rsquo;re not sure what this means yet&mldr;</p><p>For now, we will rename the four aforementioned arrays $P$, $Q$, $R$ and $S$. We will also rename <code>sub_16EA</code> as <code>init_pipes</code>.</p><h2 id=understanding-the-big-picture>Understanding the big picture</h2><p>Let&rsquo;s come back to the <code>main</code> function. After using our username to generate a permutation and initializing all these pipes, the binary starts madly forking itself:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>for</span> ( i <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; i <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>3</span>; <span style=color:#f92672>++</span>i )
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> ( j <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; j <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>3</span>; <span style=color:#f92672>++</span>j )
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        v7 <span style=color:#f92672>=</span> <span style=color:#a6e22e>fork</span>();
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> ( v7 <span style=color:#f92672>==</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span> )
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>puts</span>(<span style=color:#e6db74>&#34;fork failed&#34;</span>);
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>exit</span>(<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> ( <span style=color:#f92672>!</span>v7 )
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>goto</span> LABEL_10;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>LABEL_10:
</span></span><span style=display:flex><span><span style=color:#75715e>// ...
</span></span></span></code></pre></div><p>In fact, the master process will fork and spawn <strong>16 children processes</strong>.</p><p>How convenient&mldr; What if our little cells from earlier are actually these processes, and they use pipes to communicate?</p><p>The rest of the <code>main</code> function depends on whether we&rsquo;re a child process or the master process. If we&rsquo;re a <strong>child process</strong>:</p><ol><li>We put <code>random_permutation[4 * i + j]</code> inside the static global variable <code>byte_6044</code>, which we will rename <code>cell_number</code>.</li><li>We call <code>sub_2080(i, j)</code>. Since this function&rsquo;s logic is wrapped inside an infinite loop, we&rsquo;ll rename it <code>child_loop</code>.</li></ol><p>Before diving any further in what the child processes do exactly, let&rsquo;s reverse the <strong>master process</strong>.</p><p>It starts by using <code>setsid</code> and <code>getpgid</code> to ensure it is the process group leader, and get the process group id, which should be its own PID. Indeed, in Linux, processes have a <em>Process ID</em> (PID), a <em>Parent Process ID</em> (PPID), and can also have a <em>Process Group ID</em> (PGID). If a process&rsquo; PGID is its PID, then it is a process group leader.</p><p>Here, all the child processes belong to the same group. This allows, for instance, to kill all children at once with <code>killpg</code> (in <code>sub_1388</code>).</p><p>Then, the master process finally reads the <strong>serial</strong> from standard input. The serial goes through <code>sub_1530</code>, where it is converted from uppercase hexadecimal to base 4. The resulting array is a sequence of integers from $1$ to $4$. For example, the serial <code>AB42</code> would be converted to $(3, 3, 3, 4, 2, 1, 1, 3)$.</p><p>Next, the random permutation of $\{0, \ldots, 15\}$ is seen as a $4 \times 4$ grid, and the master process loops until it finds the coordinates $(k, l)$ of $0$ inside the grid. Then, it calls <code>sub_1A90</code> with <code>S[4 * k + l]</code> and the converted serial. Remember <code>S[4 * k + l]</code> was the writing end of a pipe associated with the cell $(k, l)$. This function is relatively simple:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>ssize_t</span> <span style=color:#66d9ef>__fastcall</span> <span style=color:#a6e22e>sub_1A90</span>(<span style=color:#66d9ef>int</span> pipe_writing_end, <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>serial, <span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>int</span> serial_length)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>buf; <span style=color:#75715e>// [rsp+10h] [rbp-10h]
</span></span></span><span style=display:flex><span>    <span style=color:#66d9ef>ssize_t</span> v6; <span style=color:#75715e>// [rsp+18h] [rbp-8h]
</span></span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    buf <span style=color:#f92672>=</span> (<span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>)<span style=color:#a6e22e>malloc</span>(serial_length <span style=color:#f92672>+</span> <span style=color:#ae81ff>3</span>);
</span></span><span style=display:flex><span>    <span style=color:#f92672>*</span>buf <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;S&#39;</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>*</span>(_WORD <span style=color:#f92672>*</span>)(buf <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>) <span style=color:#f92672>=</span> serial_length;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>memcpy</span>(buf <span style=color:#f92672>+</span> <span style=color:#ae81ff>3</span>, serial, serial_length);
</span></span><span style=display:flex><span>    v6 <span style=color:#f92672>=</span> <span style=color:#a6e22e>write</span>(pipe_writing_end, buf, serial_length <span style=color:#f92672>+</span> <span style=color:#ae81ff>3</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>free</span>(buf);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> v6;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>It seems like it is an important function, as there are some other references to it elsewhere in the binary. It writes a buffer to the pipe, composed of:</p><ul><li>The character <code>'S'</code> (a header? a type?)</li><li>The converted serial length (2 bytes)</li><li>The converted serial</li></ul><p>Looks like a TLV encoding (<em>type, length, value</em>) for a protocol of some kind. Perhaps cells communicate to each other using some custom protocol? Let&rsquo;s rename it <code>send_serial</code> for now.</p><p>After writing the serial to a pipe associated to the cell $(k, l)$ which is itself associated to the cell number $0$, the master process enters its own loop, <code>master_loop</code>.</p><p>Since we&rsquo;re trying to follow what happens in this binary in some &ldquo;time linear&rdquo; fashion, let&rsquo;s assume one of the child processes will actually read the serial that was just written and start reversing the child loop.</p><p>The <strong>child loop</strong> is somewhat denser that the other functions, so I will try to cut to the interesting bits. The infinite loop starts with:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>v21 <span style=color:#f92672>=</span> <span style=color:#f92672>&amp;</span>readfds;
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> ( i <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; i <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>0xF</span>; <span style=color:#f92672>++</span>i )
</span></span><span style=display:flex><span>    v21<span style=color:#f92672>-&gt;</span>fds_bits[i] <span style=color:#f92672>=</span> <span style=color:#ae81ff>0LL</span>;
</span></span></code></pre></div><p>IDA helps a lot here by recognizing an <a href=https://linux.die.net/man/3/fd_set><code>fd_set</code> structure</a>. It is usually used with the <code>select</code> / <code>pselect</code> functions. Those allow to monitor multiple file descriptors at the same time. Can you see where this is going?</p><p>Along with <code>select</code> come very handy macros such as <code>FD_ZERO</code> (the loop above which sets the <code>fds_bits</code> to zero), <code>FD_ISSET</code> and <code>FD_SET</code>, which we encounter a few lines below:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>for</span> (j <span style=color:#f92672>=</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>; j <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>1</span>; <span style=color:#f92672>++</span>j) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> (k <span style=color:#f92672>=</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>; k <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>1</span>; <span style=color:#f92672>++</span>k) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> ( (<span style=color:#f92672>!</span>j <span style=color:#f92672>||</span> <span style=color:#f92672>!</span>k) <span style=color:#f92672>&amp;&amp;</span> (j <span style=color:#f92672>||</span> k) <span style=color:#f92672>&amp;&amp;</span> j <span style=color:#f92672>+</span> a1 <span style=color:#f92672>&gt;=</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>&amp;&amp;</span> j <span style=color:#f92672>+</span> a1 <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>3</span> <span style=color:#f92672>&amp;&amp;</span> k <span style=color:#f92672>+</span> a2 <span style=color:#f92672>&gt;=</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>&amp;&amp;</span> k <span style=color:#f92672>+</span> a2 <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>3</span> ) {
</span></span><span style=display:flex><span>            v2 <span style=color:#f92672>=</span> (<span style=color:#66d9ef>int</span>)P[<span style=color:#ae81ff>64</span> <span style=color:#f92672>*</span> j <span style=color:#f92672>+</span> <span style=color:#ae81ff>64</span> <span style=color:#f92672>*</span> a1 <span style=color:#f92672>+</span> <span style=color:#ae81ff>16</span> <span style=color:#f92672>*</span> k <span style=color:#f92672>+</span> <span style=color:#ae81ff>16</span> <span style=color:#f92672>*</span> a2 <span style=color:#f92672>+</span> <span style=color:#ae81ff>4</span> <span style=color:#f92672>*</span> a1 <span style=color:#f92672>+</span> a2] <span style=color:#f92672>/</span> <span style=color:#ae81ff>64</span>;
</span></span><span style=display:flex><span>            v3 <span style=color:#f92672>=</span> (<span style=color:#66d9ef>int</span>)P[<span style=color:#ae81ff>64</span> <span style=color:#f92672>*</span> j <span style=color:#f92672>+</span> <span style=color:#ae81ff>64</span> <span style=color:#f92672>*</span> a1 <span style=color:#f92672>+</span> <span style=color:#ae81ff>16</span> <span style=color:#f92672>*</span> k <span style=color:#f92672>+</span> <span style=color:#ae81ff>16</span> <span style=color:#f92672>*</span> a2 <span style=color:#f92672>+</span> <span style=color:#ae81ff>4</span> <span style=color:#f92672>*</span> a1 <span style=color:#f92672>+</span> a2];
</span></span><span style=display:flex><span>            readfds.fds_bits[v2] <span style=color:#f92672>|=</span> <span style=color:#ae81ff>1LL</span> <span style=color:#f92672>&lt;&lt;</span> ((((<span style=color:#a6e22e>HIDWORD</span>(v3) <span style=color:#f92672>&gt;&gt;</span> <span style=color:#ae81ff>26</span>) <span style=color:#f92672>+</span> v3) <span style=color:#f92672>&amp;</span> <span style=color:#ae81ff>0x3F</span>) <span style=color:#f92672>-</span> (<span style=color:#a6e22e>HIDWORD</span>(v3) <span style=color:#f92672>&gt;&gt;</span> <span style=color:#ae81ff>26</span>));
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> ( v17 <span style=color:#f92672>&lt;</span> (<span style=color:#66d9ef>int</span>)P[<span style=color:#ae81ff>64</span> <span style=color:#f92672>*</span> j <span style=color:#f92672>+</span> <span style=color:#ae81ff>64</span> <span style=color:#f92672>*</span> a1 <span style=color:#f92672>+</span> <span style=color:#ae81ff>16</span> <span style=color:#f92672>*</span> k <span style=color:#f92672>+</span> <span style=color:#ae81ff>16</span> <span style=color:#f92672>*</span> a2 <span style=color:#f92672>+</span> <span style=color:#ae81ff>4</span> <span style=color:#f92672>*</span> a1 <span style=color:#f92672>+</span> a2] )
</span></span><span style=display:flex><span>                v17 <span style=color:#f92672>=</span> P[<span style=color:#ae81ff>64</span> <span style=color:#f92672>*</span> j <span style=color:#f92672>+</span> <span style=color:#ae81ff>64</span> <span style=color:#f92672>*</span> a1 <span style=color:#f92672>+</span> <span style=color:#ae81ff>16</span> <span style=color:#f92672>*</span> k <span style=color:#f92672>+</span> <span style=color:#ae81ff>16</span> <span style=color:#f92672>*</span> a2 <span style=color:#f92672>+</span> <span style=color:#ae81ff>4</span> <span style=color:#f92672>*</span> a1 <span style=color:#f92672>+</span> a2];
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>For reference, <code>a1</code> and <code>a2</code> are the coordinates of the cell associated to the current child process.</p><p>Here, the three hideous lines with <code>v2</code> and <code>v3</code> can actually be rewritten as:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#a6e22e>FD_SET</span>(P[<span style=color:#ae81ff>64</span> <span style=color:#f92672>*</span> (a1 <span style=color:#f92672>+</span> j) <span style=color:#f92672>+</span> <span style=color:#ae81ff>16</span> <span style=color:#f92672>*</span> (a2 <span style=color:#f92672>+</span> k) <span style=color:#f92672>+</span> <span style=color:#ae81ff>4</span> <span style=color:#f92672>*</span> a1 <span style=color:#f92672>+</span> a2], <span style=color:#f92672>&amp;</span>readfds);
</span></span></code></pre></div><p>The <code>FD_SET</code> macro is used to add a file descriptor to the set of file descriptors to monitor. Therefore, the child process is basically saying it wants to <strong>monitor the reading ends of the pipes linked to all of its neighbours</strong>.</p><p>A last file descriptor is also added to the set:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#a6e22e>FD_SET</span>(R[<span style=color:#ae81ff>16</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>4</span> <span style=color:#f92672>*</span> a1 <span style=color:#f92672>+</span> a2], <span style=color:#f92672>&amp;</span>readfds);
</span></span></code></pre></div><p>Since we know the $S$ array of file descriptors was used by the master process to write data, it may be safe to assume the $R$ array is used by the child processes to <strong>read data that was sent by the master process</strong>.</p><p>There&rsquo;s even more: remember at the beginning, the master process looked for the coordinates of the $0$ cell in the random permutation and wrote the serial to a pipe associated to these coordinates. This (probably) means two things:</p><ul><li>each process is associated to a cell and can be identified by its coordinates on a $4 \times 4$ grid;</li><li>each process is associated to a cell number according to the initial random permutation (remember the <code>cell_number</code> global variable? it has a different value for each child process!)</li></ul><p>At this point and with our different assumptions, we can break down the architecture this way:</p><img src=/img/pipedream/diagram2.png style="margin:0 auto;margin-top:2em;margin-bottom:2em" alt="First idea of the architecture"><p>The black arrows represent the $P$ and $Q$ arrays of pipes between child processes, whereas the blue arrows represent the $R$ and $S$ arrays of pipes that allow communication between each child and the master process. Of course, the master process is linked with every child process, but the diagram would have been too cluttered if I were to draw all the pipes.</p><p>The first interaction happens when the master process sends the serial to the process whose cell number is $0$. Now what happens next? Let&rsquo;s continue reversing the child loop to find out.</p><p>The <code>select</code> function is finally called with <code>readfds</code>, the set of file descriptors to be monitored. For instance, in the above diagram, the cell $0$ monitors the reading ends of the pipes coming from the cells $9$, $6$ and $15$, as well as the one coming from the master process.</p><p>There are three kinds of values that <code>select</code> can return:</p><ul><li>$-1$ if there has been an unexpected error within <code>select</code>;</li><li>$0$ if there hasn&rsquo;t been any update within a certain timeout duration (30 seconds here);</li><li>the number of file descriptors where something interesting happened otherwise.</li></ul><p>Then, we have again some kind of nasty magic operating:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>v7 <span style=color:#f92672>=</span> (<span style=color:#66d9ef>int</span>)R[<span style=color:#ae81ff>4</span> <span style=color:#f92672>*</span> a1 <span style=color:#f92672>+</span> a2];
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> ( (readfds.fds_bits[(<span style=color:#66d9ef>int</span>)R[<span style=color:#ae81ff>4</span> <span style=color:#f92672>*</span> a1 <span style=color:#f92672>+</span> a2] <span style=color:#f92672>/</span> <span style=color:#ae81ff>64</span>] <span style=color:#f92672>&amp;</span> (<span style=color:#ae81ff>1LL</span> <span style=color:#f92672>&lt;&lt;</span> ((((<span style=color:#a6e22e>HIDWORD</span>(v7) <span style=color:#f92672>&gt;&gt;</span> <span style=color:#ae81ff>26</span>) <span style=color:#f92672>+</span> v7) <span style=color:#f92672>&amp;</span> <span style=color:#ae81ff>0x3F</span>) <span style=color:#f92672>-</span> (<span style=color:#a6e22e>HIDWORD</span>(v7) <span style=color:#f92672>&gt;&gt;</span> <span style=color:#ae81ff>26</span>)))) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> )
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>break</span>;
</span></span></code></pre></div><p>This can be rewritten using the <code>FD_ISSET</code> macro:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>FD_ISSET</span>(R[<span style=color:#ae81ff>16</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>4</span> <span style=color:#f92672>*</span> a1 <span style=color:#f92672>+</span> a2], <span style=color:#f92672>&amp;</span>readfds))
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>break</span>;
</span></span></code></pre></div><p><code>FD_ISSET</code> checks if a file descriptor is &ldquo;ready&rdquo; for use â€” here, for reading. If <code>R[16 * 0 + 4 * a1 + a2]</code> is set, this means the master process has sent something to the child process by writing to the corresponding $S$ pipe. If it&rsquo;s not set, then we know the set file descriptor is a pipe linked with an adjacent child cell.</p><p>In the latter case, the child process loops to find which adjacent cell actually sent something. It then proceeds to call <code>sub_19B4</code> with the file descriptor of interest. This function does not do much: it merely reads one byte from the file descriptor, and returns it.</p><p>Depending on the value of this byte:</p><ul><li>If it&rsquo;s a <code>'C'</code>, the child process reads another byte, does stuff and seems to send something back to the adjacent cell on the reverse pipe&mldr;</li><li>If it&rsquo;s an <code>'S'</code>, the child process reads a length, then something of that length, and then&mldr; a lot of stuff happens&mldr;</li></ul><p>It&rsquo;s starting to get a bit fuzzy, so let&rsquo;s try to take a step back. We will overlook the protocol for now, and directly skip to the end, which is: <strong>how do we reach success?</strong></p><p>If we look for strings in the binary, an interesting one stands out: <code>"That's pretty good!"</code>. It&rsquo;s referenced in the <strong>master loop</strong>: it seems that upon reception of a certain message, a <strong>verification</strong> of some sort happens:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>char</span> state[<span style=color:#ae81ff>16</span>];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>memset</span>(state, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>16</span>);
</span></span><span style=display:flex><span><span style=color:#a6e22e>sub_1D05</span>(state);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> k <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; k <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>4</span>; k<span style=color:#f92672>++</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> l <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; l <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>4</span>; l<span style=color:#f92672>++</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (state[<span style=color:#ae81ff>4</span> <span style=color:#f92672>*</span> k <span style=color:#f92672>+</span> l] <span style=color:#f92672>!=</span> <span style=color:#ae81ff>4</span> <span style=color:#f92672>*</span> k <span style=color:#f92672>+</span> l) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>goto</span> bad_boy;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;That&#39;s pretty good!</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span><span style=color:#a6e22e>kill_children</span>();
</span></span><span style=display:flex><span><span style=color:#a6e22e>exit</span>(<span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>bad_boy:
</span></span><span style=display:flex><span><span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;You failed really hard. At least you managed to survive...</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span><span style=color:#a6e22e>kill_children</span>();
</span></span><span style=display:flex><span><span style=color:#a6e22e>exit</span>(<span style=color:#ae81ff>1</span>);
</span></span></code></pre></div><p>The <code>sub_1D05</code> function seems to send a certain message to each child process, and wait for a response, which is put in <code>state</code>. It is also probably used to poll on the child processes to check whether they&rsquo;re still alive or not (hence the <code>"I lost my child :("</code> that we usually get when we run the binary).</p><p>We may assume <code>sub_1D05</code> <strong>asks each cell for their cell number</strong>. The constructed state array is then compared to $(0, \ldots, 15)$. This is the condition on which we win.</p><p>Since the state was initially a random permutation of $\{ 0, \ldots, 15 \}$, we may also assume there is, somewhere, a mechanism that changes the cells&rsquo; numbers (based on the serial?).</p><img src=/img/pipedream/diagram3.png style="margin:0 auto;margin-top:2em;margin-bottom:2em" alt="Solving the grid?"><p>From now there are two possibilities.</p><ul><li>Follow your intuition and manage to guess what this is all about&mldr;</li><li>&mldr;or start reversing the protocol.</li></ul><p>Of course, for the sake of this article&rsquo;s completeness, we will opt for the latter!</p><h2 id=reversing-the-protocol>Reversing the protocol</h2><p>This writeup would be too long if I were to detail the entire reversing process, so in this part I will just explain the <strong>protocol used by the pipes</strong>.</p><p>All the messages follow this structure:</p><pre tabindex=0><code>[msgType (1 byte)] + [body]
</code></pre><p>The different message types are the following. We will go through each one in depth.</p><table><thead><tr><th style=text-align:center>msgType</th><th style=text-align:left>Description</th><th style=text-align:left>Use cases</th></tr></thead><tbody><tr><td style=text-align:center><code>'S'</code></td><td style=text-align:left>Send serial</td><td style=text-align:left>Child -> Child, Master -> Child (at the beginning)</td></tr><tr><td style=text-align:center><code>'P'</code></td><td style=text-align:left>Probe child status</td><td style=text-align:left>Master -> Child</td></tr><tr><td style=text-align:center><code>'R'</code></td><td style=text-align:left>Probe response</td><td style=text-align:left>Child -> Master</td></tr><tr><td style=text-align:center><code>'C'</code></td><td style=text-align:left>Send old cell number</td><td style=text-align:left>Child -> Child</td></tr><tr><td style=text-align:center><code>'A'</code></td><td style=text-align:left>Acknowledge</td><td style=text-align:left>Child -> Child</td></tr><tr><td style=text-align:center><code>'V'</code></td><td style=text-align:left>Ask master for verification</td><td style=text-align:left>Child -> Master</td></tr></tbody></table><p><strong>Send serial</strong></p><pre tabindex=0><code>[msgType (1 byte)] + [serialLength (2 bytes)] + [serial]
</code></pre><ul><li><code>msgType</code> must be <code>'S'</code></li><li><code>serialLength</code> is the length of <code>serial</code> (little-endian)</li><li><code>serial</code> should not be null terminated</li></ul><p>This message is used by the master process to send the entire serial to the first cell ($0$), or by a child process to send the remaining serial to an adjacent cell.</p><p>Indeed, when the first cell receives the serial, it proceeds to <strong>read its first byte</strong>, and depending on its value ($1$, $2$, $3$ or $4$), it <strong>sends the rest of the serial to the left, right, up or down adjacent cell</strong>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>if</span> (msgType <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;S&#39;</span>) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Read the serial
</span></span></span><span style=display:flex><span>    serial_length <span style=color:#f92672>=</span> <span style=color:#a6e22e>read_serial</span>(R[<span style=color:#ae81ff>16</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>4</span> <span style=color:#f92672>*</span> x <span style=color:#f92672>+</span> y], buffer);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Read the next move (first byte of the serial)
</span></span></span><span style=display:flex><span>    <span style=color:#75715e>// (this function translates 1,2,3,4 to an LRUD move)
</span></span></span><span style=display:flex><span>    <span style=color:#a6e22e>convert_move</span>(buffer[<span style=color:#ae81ff>0</span>], <span style=color:#f92672>&amp;</span>dx, <span style=color:#f92672>&amp;</span>dy);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (x <span style=color:#f92672>+</span> dx <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>||</span> x <span style=color:#f92672>+</span> dx <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>3</span> <span style=color:#f92672>||</span> y <span style=color:#f92672>+</span> dy <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>||</span> y <span style=color:#f92672>+</span> dy <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>3</span>) {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// No adjacent cell here, we&#39;re out of the grid
</span></span></span><span style=display:flex><span>        <span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;You lost your path already?</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>exit</span>(<span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Send the rest of the serial to the adjacent cell
</span></span></span><span style=display:flex><span>    <span style=color:#a6e22e>send_serial</span>(Q[<span style=color:#ae81ff>64</span> <span style=color:#f92672>*</span> x <span style=color:#f92672>+</span> <span style=color:#ae81ff>16</span> <span style=color:#f92672>*</span> y <span style=color:#f92672>+</span> <span style=color:#ae81ff>4</span> <span style=color:#f92672>*</span> (x <span style=color:#f92672>+</span> dx) <span style=color:#f92672>+</span> (y <span style=color:#f92672>+</span> dy)], buffer <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>, serial_length <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>When the next cell receives the serial, things get a bit more complicated: we&rsquo;ll see why with the <code>C</code>, <code>A</code> and <code>V</code> message types. But fundamentally, it will also send the rest of the serial to a next adjacent cell. If a child process receives a 1-byte serial, it also sends a last <em>Send serial</em> message with <code>serialLength = 0</code>.</p><p><strong>Probe child status</strong></p><pre tabindex=0><code>[msgType (1 byte)]
</code></pre><ul><li><code>msgType</code> must be <code>'P'</code></li></ul><p>This message is used by the master process to <strong>probe all children for their cell numbers</strong>. Upon reception of this message, a child process responds with a <em>Probe response</em> message.</p><p>This appears in the function <code>probe_children_status</code>, which sends a probe <code>P</code> to all children to check whether they are alive, but also to get their cell numbers and store them in a 16-byte state array. Hence, this function is periodically called during the master loop, but also called once when asked for verification (see <code>V</code>).</p><p><strong>Probe response</strong></p><pre tabindex=0><code>[msgType (1 byte)] + [cellNumber (1 byte)]
</code></pre><ul><li><code>msgType</code> must be <code>'R'</code></li><li><code>cellNumber</code> must be in $\{ 0, \ldots, 15 \}$</li></ul><p>This message is used by a child process to respond to the master&rsquo;s <em>Probe child status</em> with their cell number.</p><p>The master process can consider one of their children to be dead if they do not answer with a <em>Probe response</em> within a certain timeout delay (30 seconds).</p><p>In the child loop:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>// Probe child status
</span></span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> (msgType <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;P&#39;</span>) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Send cell number back to master
</span></span></span><span style=display:flex><span>    <span style=color:#a6e22e>probe_response</span>(S[<span style=color:#ae81ff>16</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>1</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>4</span> <span style=color:#f92672>*</span> x <span style=color:#f92672>+</span> y], cell_number);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><strong>Send old cell number</strong></p><pre tabindex=0><code>[msgType (1 byte)] + [oldCellNumber (1 byte)]
</code></pre><ul><li><code>msgType</code> must be <code>'C'</code></li><li><code>oldCellNumber</code> must be in $\{ 1, \ldots, 15 \}$</li></ul><p>This message is used by a child process to send back their old cell number in response to a <em>Send serial</em> message from an adjacent child process cell.</p><p>Indeed, when a child process sends the remaining serial (<code>S</code>) to another child process, here is what does the new cell:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>if</span> (msgType <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;S&#39;</span>) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Received remaining serial
</span></span></span><span style=display:flex><span>    serial_length <span style=color:#f92672>=</span> <span style=color:#a6e22e>read_serial</span>(P[<span style=color:#ae81ff>64</span> <span style=color:#f92672>*</span> (x <span style=color:#f92672>+</span> dx) <span style=color:#f92672>+</span> <span style=color:#ae81ff>16</span> <span style=color:#f92672>*</span> (y <span style=color:#f92672>+</span> dy) <span style=color:#f92672>+</span> <span style=color:#ae81ff>4</span> <span style=color:#f92672>*</span> x <span style=color:#f92672>+</span> y], buffer);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Send old cell number back to adjacent cell
</span></span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>send_old_cell_number</span>(Q[<span style=color:#ae81ff>64</span> <span style=color:#f92672>*</span> x <span style=color:#f92672>+</span> <span style=color:#ae81ff>16</span> <span style=color:#f92672>*</span> y <span style=color:#f92672>+</span> <span style=color:#ae81ff>4</span> <span style=color:#f92672>*</span> (x <span style=color:#f92672>+</span> dx) <span style=color:#f92672>+</span> (y <span style=color:#f92672>+</span> dy)], cell_number) <span style=color:#f92672>==</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;write error</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>exit</span>(<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    cell_number <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The new cell becomes $0$, and sends its old cell number back to the previous cell, which does this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>if</span> (msgType <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;C&#39;</span>) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Change cell number
</span></span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>read</span>(P[<span style=color:#ae81ff>64</span> <span style=color:#f92672>*</span> (x <span style=color:#f92672>+</span> dx) <span style=color:#f92672>+</span> <span style=color:#ae81ff>16</span> <span style=color:#f92672>*</span> (y <span style=color:#f92672>+</span> dy) <span style=color:#f92672>+</span> <span style=color:#ae81ff>4</span> <span style=color:#f92672>*</span> x <span style=color:#f92672>+</span> y], <span style=color:#f92672>&amp;</span>cell_number, <span style=color:#ae81ff>1</span>) <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;read error</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>exit</span>(<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (cell_number <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>||</span> cell_number <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>15</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;malformed data</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>exit</span>(<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Acknowledge
</span></span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>acknowledge</span>(Q[<span style=color:#ae81ff>64</span> <span style=color:#f92672>*</span> x <span style=color:#f92672>+</span> <span style=color:#ae81ff>16</span> <span style=color:#f92672>*</span> y <span style=color:#f92672>+</span> <span style=color:#ae81ff>4</span> <span style=color:#f92672>*</span> (x <span style=color:#f92672>+</span> dx) <span style=color:#f92672>+</span> (y <span style=color:#f92672>+</span> dy)]) <span style=color:#f92672>==</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;write error</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>exit</span>(<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><strong>The previous cell sets its new cell number to the one sent by the next cell!</strong></p><img src=/img/pipedream/diagram4.png style="margin:0 auto;margin-top:2em;margin-bottom:2em" alt="Cells switching numbers"><p>This is how we are able to move the cells. With this information in our possession, we could already start solving the puzzle&mldr;</p><p><strong>Acknowledge</strong></p><pre tabindex=0><code>[msgType (1 byte)]
</code></pre><ul><li><code>msgType</code> must be <code>'A'</code></li></ul><p>This message is used by a child process to acknowledge they received a <em>Send old cell number</em> message. It is primarily useful for synchronization purposes: the new cell will not process the remaining part of the serial before it received this acknowledgement.</p><img src=/img/pipedream/diagram5.png style="margin:0 auto;margin-top:2em;margin-bottom:2em" alt="Acknowledge message"><p><strong>Ask master for verification</strong></p><pre tabindex=0><code>[msgType (1 byte)]
</code></pre><ul><li><code>msgType</code> must be <code>'V'</code></li></ul><p>Last but not least, this message is used by a child process once there are no more remaining moves in the serial to ask for the master process to <strong>verify the state of the grid</strong>. This is, as we saw earlier, what results in a win or a loss.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>if</span> (serial_length <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>ask_master_for_verification</span>(S[<span style=color:#ae81ff>16</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>1</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>4</span> <span style=color:#f92672>*</span> x <span style=color:#f92672>+</span> y]) <span style=color:#f92672>==</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;write error</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>exit</span>(<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Upon reception of this message, the master process sends a <em>Probe child status</em> message to every children, reconstruct the state array and announce whether the user won or lost before killing every children.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>if</span> (msgType <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;V&#39;</span>) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Child asked for verification
</span></span></span><span style=display:flex><span>    <span style=color:#75715e>// Reprobe everyone and construct state matrix
</span></span></span><span style=display:flex><span>    <span style=color:#a6e22e>memset</span>(state, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>16</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>probe_children_status</span>(state);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Check if instance is solved
</span></span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> k <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; k <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>4</span>; k<span style=color:#f92672>++</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> l <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; l <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>4</span>; l<span style=color:#f92672>++</span>) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (state[<span style=color:#ae81ff>4</span> <span style=color:#f92672>*</span> k <span style=color:#f92672>+</span> l] <span style=color:#f92672>!=</span> <span style=color:#ae81ff>4</span> <span style=color:#f92672>*</span> k <span style=color:#f92672>+</span> l) {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>goto</span> bad_boy;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;That&#39;s pretty good!</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>kill_children</span>();
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>exit</span>(<span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    bad_boy:
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;You failed really hard. At least you managed to survive...</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>kill_children</span>();
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>exit</span>(<span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=puzzle-state-machine>Puzzle state machine</h2><p>Now that we have acquired a deeper understanding of the binary, we can try to summarize its inner workings schematically.</p><img src=/img/pipedream/state_machine.png style="margin:0 auto;margin-top:2em;margin-bottom:2em" alt="Puzzle state machine"><p>So&mldr; does it ring a bell?</p><p>If not, let me introduce you to the <a href=https://en.wikipedia.org/wiki/15_puzzle><strong>Fifteen Puzzle</strong></a>!</p><p>The <em>Fifteen Puzzle</em> is a sliding puzzle with a $4 \times 4$ grid that has 15 square tiles and one hole. Tiles are associated a number and can slide. When you slide a tile next to a hole, it fills this hole, but also of course creates a new hole.</p><img src=/img/pipedream/fifteen_puzzle.png style="margin:0 auto;margin-top:2em;margin-bottom:2em" alt="Puzzle state machine"><p>The goal is to rearrange the tiles from $1$ to $15$. Depending on variants, the hole has to eventually sit in the top-left corner or the bottom-right corner. There are also variants where the goal is to unscramble a picture.</p><p>In our case, the hole is represented by the cell number $0$. When two cells swap numbers, it&rsquo;s actually the second cell that fills the place of the old $0$ cell â€” this is how tiles slide.</p><p><strong>In conclusion, the username is used to derive a random instance of a <em>Fifteen Puzzle</em> game, and the serial encodes which tile slides at each step. The goal is to solve the puzzle!</strong></p><h2 id=writing-a-keygen>Writing a keygen</h2><p>Now that we have all the pieces together, it&rsquo;s time to write a keygen. Fortunately, there are plenty of <em>Fifteen Puzzle</em> solvers on the Internet in many languages, so it shouldn&rsquo;t be too hard to come up with something.</p><p>I will not share my keygen because it&rsquo;s dirty and embarassing. It basically just computes the initial state and then runs a slightly modified version of a C++ <em>Fifteen Puzzle</em> solver I shamelessly cloned and compiled. Modifications include:</p><ul><li>changing the goal matrix (most solvers put the hole at the bottom-right);</li><li>outputting the solution in a format that is convenient for us, i.e. LRUD moves relatively to the hole&rsquo;s position at each step.</li></ul><p>Most <em>Fifteen Puzzle</em> solvers seem to use A* or IDA*. Some are faster than the others, and some are easier to modify than the others, so in a short-time competition context (which ECW is actually not really since it spans for two weeks&mldr;), finding an implementation that satisfies our needs doesn&rsquo;t necessarily come right away.</p><p>You may also have noticed a little something that makes writing a &ldquo;legitimate&rdquo; keygen impossible.</p><p>It can be shown that <strong>among all the possible starting positions, only half of them actually are solvable</strong>. Indeed, it is easy to catch that the parity of the permutation of the cells plus the parity of the taxicab distance of the hole from its goal position (the top-left corner) is time invariant for a given instance of the puzzle. We can thus check if an instance is solvable by computing the invariant quantity and comparing it to $0$.</p><p>There&rsquo;s actually a second, more subtle issue. Remember how the serial is converted? We have to provide a hexadecimal representation of a sequence of base 4 moves. This means that a hexadecimal character, like <code>B</code>, encodes two moves at once ($(3, 4)$). Consequently, we have no choice but to provide <strong>a solution of even length</strong>. Again, having a solution of even length is equivalent to the number of inversions in the permutation being even.</p><p>Therefore, for a given username, which we suppose uniformly randomly generated, there&rsquo;s only a $\frac{1}{4}$ probability that we can find a corresponding valid serial.</p><p>Some example runs:</p><pre tabindex=0><code>$ python keygen.py Username1
Odd-length solution
$ python keygen.py Username2
Serial: 2728F729973360972973608
$ python keygen.py Username3
Serial: F68CD60D708D970962720D8FD982
$ python keygen.py Username4
Not solvable
$ python keygen.py Username5
Serial: 30A73D58A7C8F6A7F28F6602
$ python keygen.py Username6
Not solvable
$ python keygen.py abcdefghijklmnopqrstuvwxyz
Odd-length solution
</code></pre><pre tabindex=0><code>$ ./pipedream
Enter username: Username2
Enter serial: 2728F729973360972973608
That&#39;s pretty good!
[1]    3174889 killed     ./pipedream
</code></pre><p>Victory!</p><h2 id=against-the-remote>Against the remote</h2><p>Final stretch: defeat the remote and get the flag.</p><h3 id=first-step>First step</h3><p>We connect to the remote and are greeted with a &ldquo;gentle&rdquo; task.</p><pre tabindex=0><code>[+] Hello there. Did you manage to find your way?
[+] Just a quick sanity check, I&#39;ll start with something gentle.
[+] I will give you 5 usernames, and each time you will have to send me a valid serial in less than 15 seconds.

[?] Give me a valid serial for the user &#39;boHehgOO22&#39;.
&gt;&gt;&gt;
</code></pre><p>Solving the fifteen puzzle in fifteen seconds should be largely enough. We have to do this 5 times.</p><p>Thanksfully, it seems that the generated usernames are all &ldquo;valid&rdquo; (the grids they generate are all solvable, and their solutions are always of even length).</p><p>Nothing too special here:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> pwn <span style=color:#f92672>import</span> <span style=color:#f92672>*</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> keygen<span style=color:#f92672>,</span> crctools
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>r <span style=color:#f92672>=</span> remote(<span style=color:#e6db74>&#39;localhost&#39;</span>, <span style=color:#ae81ff>42000</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> k <span style=color:#f92672>in</span> range(<span style=color:#ae81ff>5</span>):
</span></span><span style=display:flex><span>    c <span style=color:#f92672>=</span> r<span style=color:#f92672>.</span>recvuntil(<span style=color:#e6db74>b</span><span style=color:#e6db74>&#34;&gt;&gt;&gt; &#34;</span>)
</span></span><span style=display:flex><span>    print(c<span style=color:#f92672>.</span>decode())
</span></span><span style=display:flex><span>    user <span style=color:#f92672>=</span> c<span style=color:#f92672>.</span>split(<span style=color:#e6db74>b</span><span style=color:#e6db74>&#34;user &#39;&#34;</span>)[<span style=color:#ae81ff>1</span>]<span style=color:#f92672>.</span>split(<span style=color:#e6db74>b</span><span style=color:#e6db74>&#34;&#39;&#34;</span>)[<span style=color:#ae81ff>0</span>]<span style=color:#f92672>.</span>decode()
</span></span><span style=display:flex><span>    serial <span style=color:#f92672>=</span> keygen<span style=color:#f92672>.</span>keygen(user)
</span></span><span style=display:flex><span>    r<span style=color:#f92672>.</span>sendline(serial<span style=color:#f92672>.</span>encode())
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>r<span style=color:#f92672>.</span>interactive()
</span></span></code></pre></div><p>Let&rsquo;s run it:</p><pre tabindex=0><code>[+] Opening connection to localhost on port 42000: Done
[+] Hello there. Did you manage to find your way?
[+] Just a quick sanity check, I&#39;ll start with something gentle.
[+] I will give you 5 usernames, and each time you will have to send me a valid serial in less than 15 seconds.

[?] Give me a valid serial for the user &#39;E8kMpXJaqY&#39;.
&gt;&gt;&gt; 
Serial: C8DC9D7260973297336720DA8D60
[+] Correct!

[?] Give me a valid serial for the user &#39;NtL4fPJID6&#39;.
&gt;&gt;&gt; 
Serial: 0D63CD668F0D5A30D58267C88
[+] Correct!

[?] Give me a valid serial for the user &#39;PpGRKyBz9F&#39;.
&gt;&gt;&gt; 
Serial: DA9C257F20A7F6A3D9C358C2A
[+] Correct!

[?] Give me a valid serial for the user &#39;be1VpeDkA2&#39;.
&gt;&gt;&gt; 
Serial: 95CD8095C27CA3D9DA27CA0D632
[+] Correct!

[?] Give me a valid serial for the user &#39;EqM8S0yWey&#39;.
&gt;&gt;&gt; 
Serial: 98F68D7367263267CA3DC8D60A
[+] Correct!

[+] Easy, right?
[+] Now I will ask you to give me 1337 usernames, and a valid serial for each one.
[+] Every username should be distinct, [0-9A-Za-z]+ and start with &#39;6FnUdNnG99&#39;.
[+] You have 10 seconds for the whole thing. Good luck!
</code></pre><h3 id=a-little-twist>A little twist</h3><p>There&rsquo;s a second step&mldr; 1337 usernames in 10 seconds? I don&rsquo;t know if there&rsquo;s an implementation out there that can go that fast on an average computer. My keygen already takes a few seconds for each username.</p><p>There must be a way to entirely circumvent this step. We know we have a new degree of freedom: we can choose <strong>arbitrary usernames</strong> (as long as they start with the given prefix).</p><p>Of course, the idea is that there is a <strong>weakness</strong> in this hospital&rsquo;s authentication system (yeah, don&rsquo;t forget we&rsquo;re trying to hack into a backdoor to arrest evil hacktivists&mldr;).</p><p>Since the initial grid is derived from a PRNG seeded with 32 bits of entropy, only $\frac{2^{32}}{16!} \approx 0.02\%$ of the initial grid space is covered. More particularly, it is trivial to generate many collisions because the initial grid only depends on the value of the username&rsquo;s CRC32.</p><p>In order to <strong>generate CRC collisions</strong>, I used <a href=https://github.com/theonlypwner/crc32>this Python tool</a>, which I modified a bit to integrate better to my script. The <code>reverse_callback</code> function takes a prefix CRC and allows to find 4-byte, 5-byte and 6-byte alphanumeric patches to match a target CRC. Obviously, it won&rsquo;t yield 1337 patches at once, but it doesn&rsquo;t matter; we can add random junk to our string and ask for new patches until we reach 1337 usernames that all give the same CRC.</p><p>For the target CRC, we can simply choose the CRC of the last username of step 1. This way, we don&rsquo;t even have to solve another instance of the puzzle: we already know a valid serial.</p><p>Here&rsquo;s the last part of our solve script:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> binascii <span style=color:#f92672>import</span> crc32
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> crctools
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># [...]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>c <span style=color:#f92672>=</span> r<span style=color:#f92672>.</span>recvuntil(<span style=color:#e6db74>b</span><span style=color:#e6db74>&#34;Good luck!&#34;</span>)
</span></span><span style=display:flex><span>print(c<span style=color:#f92672>.</span>decode())
</span></span><span style=display:flex><span>prefix <span style=color:#f92672>=</span> c<span style=color:#f92672>.</span>split(<span style=color:#e6db74>b</span><span style=color:#e6db74>&#34;start with &#39;&#34;</span>)[<span style=color:#ae81ff>1</span>]<span style=color:#f92672>.</span>split(<span style=color:#e6db74>b</span><span style=color:#e6db74>&#34;&#39;&#34;</span>)[<span style=color:#ae81ff>0</span>]<span style=color:#f92672>.</span>decode()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>prefix_crc <span style=color:#f92672>=</span> crc32(prefix<span style=color:#f92672>.</span>encode())
</span></span><span style=display:flex><span>target_crc <span style=color:#f92672>=</span> crc32(user<span style=color:#f92672>.</span>encode()) <span style=color:#75715e># user is the last username from step1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>interesting <span style=color:#f92672>=</span> []
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>while</span> len(interesting) <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>1337</span>:
</span></span><span style=display:flex><span>    out <span style=color:#f92672>=</span> crctools<span style=color:#f92672>.</span>reverse_callback(target_crc, prefix_crc)
</span></span><span style=display:flex><span>    interesting <span style=color:#f92672>+=</span> [prefix <span style=color:#f92672>+</span> x <span style=color:#66d9ef>for</span> x <span style=color:#f92672>in</span> out]
</span></span><span style=display:flex><span>    prefix <span style=color:#f92672>+=</span> <span style=color:#e6db74>&#34;zboub&#34;</span>
</span></span><span style=display:flex><span>    prefix_crc <span style=color:#f92672>=</span> crc32(prefix<span style=color:#f92672>.</span>encode())
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>print(<span style=color:#e6db74>&#34;Generated 1337 fitting usernames with same serial&#34;</span>)
</span></span><span style=display:flex><span>interesting <span style=color:#f92672>=</span> interesting[:<span style=color:#ae81ff>1337</span>]
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> i, x <span style=color:#f92672>in</span> enumerate(interesting):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>assert</span> crc32(x<span style=color:#f92672>.</span>encode()) <span style=color:#f92672>==</span> target_crc
</span></span><span style=display:flex><span>    r<span style=color:#f92672>.</span>recv(<span style=color:#ae81ff>4096</span>)
</span></span><span style=display:flex><span>    r<span style=color:#f92672>.</span>sendline(x<span style=color:#f92672>.</span>encode())
</span></span><span style=display:flex><span>    r<span style=color:#f92672>.</span>recv(<span style=color:#ae81ff>4096</span>)
</span></span><span style=display:flex><span>    r<span style=color:#f92672>.</span>sendline(serial<span style=color:#f92672>.</span>encode())
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>r<span style=color:#f92672>.</span>interactive()
</span></span><span style=display:flex><span>r<span style=color:#f92672>.</span>close()
</span></span></code></pre></div><p>And what the end looks like:</p><pre tabindex=0><code>[+] Now I will ask you to give me 1337 usernames, and a valid serial for each one.
[+] Every username should be distinct, [0-9A-Za-z]+ and start with &#39;6FnUdNnG99&#39;.
[+] You have 10 seconds for the whole thing. Good luck!

Generated 1337 fitting usernames with same serial
[+] You really found your path... congrats!
[+] I was told you might find this useful: ECW{83b772c13bb412191875ea890fc82b90d2a9a7a7}
</code></pre><p>Note: during the ECW, on the remote CTF infrastructure, the timeout for the second step was revised to 90 seconds because of network delay.</p><h2 id=conclusion>Conclusion</h2><p>With <em>Pipe Dream</em>, my objective was to design a reverse engineering challenge that relied on system features (fork, pipes, select&mldr;) to implement a logic puzzle, while remaining as pure as possible.</p><p>I know there exist other challenges of this kind and that <em>Pipe Dream</em> is not necessarily the most innovative, but I still hope this was an enjoyable and fresh experience for most people who gave it a chance.</p><p>My only regret with this challenge is that it all comes down to an existing puzzle for which there already are plenty of solvers out there. But at the same time, I didn&rsquo;t want it to be too difficult, especially for a time-limited CTF, hence why I implemented a well-known game that people could recognize.</p><h2 id=full-source-code>Full source code</h2><p>If you are interested in it, here is the full source code of <code>pipedream</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;stdio.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;stdlib.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;string.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;unistd.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;signal.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;sys/select.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// #define DEBUG
</span></span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#define LEFT 1
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define RIGHT 2
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define UP 3
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define DOWN 4
</span></span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>int</span> next <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>pid_t</span> pgid;
</span></span><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>char</span> cell_number;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>int</span> P[<span style=color:#ae81ff>256</span>] <span style=color:#f92672>=</span> { <span style=color:#ae81ff>0</span> }; <span style=color:#75715e>// P[64 * i + 16 * j + 4 * k + l] -&gt; fd of reading end of pipe from (i, j) to (k, l)
</span></span></span><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>int</span> Q[<span style=color:#ae81ff>256</span>] <span style=color:#f92672>=</span> { <span style=color:#ae81ff>0</span> }; <span style=color:#75715e>// Q[64 * i + 16 * j + 4 * k + l] -&gt; fd of writing end of pipe from (i, j) to (k, l)
</span></span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>int</span> R[<span style=color:#ae81ff>32</span>] <span style=color:#f92672>=</span> { <span style=color:#ae81ff>0</span> }; <span style=color:#75715e>// R[16 * z + 4 * i + j] -&gt; fd of reading end of pipe from master to (i, j) if z = 0, or from (i, j) to master if z = 1
</span></span></span><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>int</span> S[<span style=color:#ae81ff>32</span>] <span style=color:#f92672>=</span> { <span style=color:#ae81ff>0</span> }; <span style=color:#75715e>// S[16 * z + 4 * i + j] -&gt; fd of writing end of pipe from master to (i, j) if z = 0, or from (i, j) to master if z = 1
</span></span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>kill_children</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>killpg</span>(pgid, SIGKILL) <span style=color:#f92672>==</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;killpg failed</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>exit</span>(<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>handle_int</span>(<span style=color:#66d9ef>int</span> sig) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>kill_children</span>();
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>exit</span>(<span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>char</span> <span style=color:#a6e22e>my_rand</span>(<span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>int</span> modulus) {
</span></span><span style=display:flex><span>    next <span style=color:#f92672>=</span> next <span style=color:#f92672>*</span> <span style=color:#ae81ff>1103515245</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>12345</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> (<span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>int</span>)(next <span style=color:#f92672>%</span> modulus);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>my_srand</span>(<span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>int</span> seed) {
</span></span><span style=display:flex><span>    next <span style=color:#f92672>=</span> seed;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>crc32_for_byte</span>(<span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>int</span> r) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>for</span>(<span style=color:#66d9ef>int</span> j <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; j <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>8</span>; <span style=color:#f92672>++</span>j)
</span></span><span style=display:flex><span>    r <span style=color:#f92672>=</span> (r <span style=color:#f92672>&amp;</span> <span style=color:#ae81ff>1</span> <span style=color:#f92672>?</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>:</span> (<span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>int</span>)<span style=color:#ae81ff>0xEDB88320L</span>) <span style=color:#f92672>^</span> r <span style=color:#f92672>&gt;&gt;</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> r <span style=color:#f92672>^</span> (<span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>int</span>)<span style=color:#ae81ff>0xFF000000L</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>crc32</span>(<span style=color:#66d9ef>const</span> <span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span> data, <span style=color:#66d9ef>size_t</span> n_bytes, <span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>int</span> <span style=color:#f92672>*</span> crc) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>int</span> table[<span style=color:#ae81ff>0x100</span>];
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span>(<span style=color:#f92672>!*</span>table)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span>(<span style=color:#66d9ef>size_t</span> i <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; i <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0x100</span>; <span style=color:#f92672>++</span>i)
</span></span><span style=display:flex><span>      table[i] <span style=color:#f92672>=</span> <span style=color:#a6e22e>crc32_for_byte</span>(i);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>for</span>(<span style=color:#66d9ef>size_t</span> i <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; i <span style=color:#f92672>&lt;</span> n_bytes; <span style=color:#f92672>++</span>i)
</span></span><span style=display:flex><span>    <span style=color:#f92672>*</span>crc <span style=color:#f92672>=</span> table[(<span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>char</span>)<span style=color:#f92672>*</span>crc <span style=color:#f92672>^</span> ((<span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>)data)[i]] <span style=color:#f92672>^</span> <span style=color:#f92672>*</span>crc <span style=color:#f92672>&gt;&gt;</span> <span style=color:#ae81ff>8</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>hex_to_base4</span>(<span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span> buffer, <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span> out_buffer) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>char</span> j <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span> (buffer[i]) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (buffer[i] <span style=color:#f92672>&gt;=</span> <span style=color:#e6db74>&#39;0&#39;</span> <span style=color:#f92672>&amp;&amp;</span> buffer[i] <span style=color:#f92672>&lt;=</span> <span style=color:#e6db74>&#39;9&#39;</span>) {
</span></span><span style=display:flex><span>            j <span style=color:#f92672>=</span> buffer[i] <span style=color:#f92672>-</span> <span style=color:#e6db74>&#39;0&#39;</span>;
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (buffer[i] <span style=color:#f92672>&gt;=</span> <span style=color:#e6db74>&#39;A&#39;</span> <span style=color:#f92672>&amp;&amp;</span> buffer[i] <span style=color:#f92672>&lt;=</span> <span style=color:#e6db74>&#39;F&#39;</span>) {
</span></span><span style=display:flex><span>            j <span style=color:#f92672>=</span> buffer[i] <span style=color:#f92672>-</span> <span style=color:#e6db74>&#39;A&#39;</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>10</span>;
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;Not even close. Bye!</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>kill_children</span>();
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>exit</span>(<span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        out_buffer[<span style=color:#ae81ff>2</span> <span style=color:#f92672>*</span> i] <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span> <span style=color:#f92672>+</span> (j <span style=color:#f92672>/</span> <span style=color:#ae81ff>4</span>);
</span></span><span style=display:flex><span>        out_buffer[<span style=color:#ae81ff>2</span> <span style=color:#f92672>*</span> i <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>] <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span> <span style=color:#f92672>+</span> (j <span style=color:#f92672>%</span> <span style=color:#ae81ff>4</span>);
</span></span><span style=display:flex><span>        i<span style=color:#f92672>++</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    out_buffer[<span style=color:#ae81ff>2</span> <span style=color:#f92672>*</span> i] <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>fisher_yates_shuffle</span>(<span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>char</span> permutation[], <span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>int</span> length) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>char</span> tmp;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>int</span> j;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; i <span style=color:#f92672>&lt;</span> length <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>; i<span style=color:#f92672>++</span>) {
</span></span><span style=display:flex><span>        tmp <span style=color:#f92672>=</span> permutation[i];
</span></span><span style=display:flex><span>        j <span style=color:#f92672>=</span> i <span style=color:#f92672>+</span> <span style=color:#a6e22e>my_rand</span>(length <span style=color:#f92672>-</span> i);
</span></span><span style=display:flex><span>        permutation[i] <span style=color:#f92672>=</span> permutation[j];
</span></span><span style=display:flex><span>        permutation[j] <span style=color:#f92672>=</span> tmp;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>initialize_pipes</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> pipefdbuf[<span style=color:#ae81ff>2</span>];
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; i <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>4</span>; i<span style=color:#f92672>++</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> j <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; j <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>4</span>; j<span style=color:#f92672>++</span>) {
</span></span><span style=display:flex><span>            <span style=color:#75715e>// Adjacent pipes
</span></span></span><span style=display:flex><span>            <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> k <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; k <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>4</span>; k<span style=color:#f92672>++</span>) {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> l <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; l <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>4</span>; l<span style=color:#f92672>++</span>) {
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>if</span> (i <span style=color:#f92672>==</span> k <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>abs</span>(j <span style=color:#f92672>-</span> l) <span style=color:#f92672>==</span> <span style=color:#ae81ff>1</span> <span style=color:#f92672>||</span> j <span style=color:#f92672>==</span> l <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>abs</span>(i <span style=color:#f92672>-</span> k) <span style=color:#f92672>==</span> <span style=color:#ae81ff>1</span>) {
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>pipe</span>(pipefdbuf) <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>                            <span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;pipe failed</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>                            <span style=color:#a6e22e>exit</span>(<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>                        }
</span></span><span style=display:flex><span>                        P[<span style=color:#ae81ff>64</span> <span style=color:#f92672>*</span> i <span style=color:#f92672>+</span> <span style=color:#ae81ff>16</span> <span style=color:#f92672>*</span> j <span style=color:#f92672>+</span> <span style=color:#ae81ff>4</span> <span style=color:#f92672>*</span> k <span style=color:#f92672>+</span> l] <span style=color:#f92672>=</span> pipefdbuf[<span style=color:#ae81ff>0</span>];
</span></span><span style=display:flex><span>                        Q[<span style=color:#ae81ff>64</span> <span style=color:#f92672>*</span> i <span style=color:#f92672>+</span> <span style=color:#ae81ff>16</span> <span style=color:#f92672>*</span> j <span style=color:#f92672>+</span> <span style=color:#ae81ff>4</span> <span style=color:#f92672>*</span> k <span style=color:#f92672>+</span> l] <span style=color:#f92672>=</span> pipefdbuf[<span style=color:#ae81ff>1</span>];
</span></span><span style=display:flex><span>                    }
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            <span style=color:#75715e>// Master &lt;-&gt; child pipes
</span></span></span><span style=display:flex><span>            <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> z <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; z <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>2</span>; z<span style=color:#f92672>++</span>) {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>pipe</span>(pipefdbuf) <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>                    <span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;pipe failed</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>                    <span style=color:#a6e22e>exit</span>(<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>                R[<span style=color:#ae81ff>16</span> <span style=color:#f92672>*</span> z <span style=color:#f92672>+</span> <span style=color:#ae81ff>4</span> <span style=color:#f92672>*</span> i <span style=color:#f92672>+</span> j] <span style=color:#f92672>=</span> pipefdbuf[<span style=color:#ae81ff>0</span>];
</span></span><span style=display:flex><span>                S[<span style=color:#ae81ff>16</span> <span style=color:#f92672>*</span> z <span style=color:#f92672>+</span> <span style=color:#ae81ff>4</span> <span style=color:#f92672>*</span> i <span style=color:#f92672>+</span> j] <span style=color:#f92672>=</span> pipefdbuf[<span style=color:#ae81ff>1</span>];
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>convert_move</span>(<span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>char</span> move, <span style=color:#66d9ef>int</span> <span style=color:#f92672>*</span> dx, <span style=color:#66d9ef>int</span> <span style=color:#f92672>*</span> dy) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>switch</span> (move) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> LEFT: <span style=color:#f92672>*</span>dx <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; <span style=color:#f92672>*</span>dy <span style=color:#f92672>=</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>; <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> RIGHT: <span style=color:#f92672>*</span>dx <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; <span style=color:#f92672>*</span>dy <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>; <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> UP: <span style=color:#f92672>*</span>dx <span style=color:#f92672>=</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>; <span style=color:#f92672>*</span>dy <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> DOWN: <span style=color:#f92672>*</span>dx <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>; <span style=color:#f92672>*</span>dy <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>default</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;malformed data</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>exit</span>(<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>char</span> <span style=color:#a6e22e>read_header</span>(<span style=color:#66d9ef>int</span> fd) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>char</span> msgType;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>read</span>(fd, <span style=color:#f92672>&amp;</span>msgType, <span style=color:#ae81ff>1</span>) <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;read error</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>exit</span>(<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> msgType;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>char</span> <span style=color:#a6e22e>read_header_master</span>(<span style=color:#66d9ef>int</span> fd) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>char</span> msgType;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>read</span>(fd, <span style=color:#f92672>&amp;</span>msgType, <span style=color:#ae81ff>1</span>) <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;read error</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>kill_children</span>();
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>exit</span>(<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> msgType;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>ssize_t</span> <span style=color:#a6e22e>send_serial</span>(<span style=color:#66d9ef>int</span> fd, <span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>char</span> serial[], <span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>int</span> serial_length) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>ssize_t</span> retval;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span> buffer <span style=color:#f92672>=</span> <span style=color:#a6e22e>malloc</span>(<span style=color:#ae81ff>3</span> <span style=color:#f92672>+</span> serial_length);
</span></span><span style=display:flex><span>    buffer[<span style=color:#ae81ff>0</span>] <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;S&#39;</span>;
</span></span><span style=display:flex><span>    buffer[<span style=color:#ae81ff>1</span>] <span style=color:#f92672>=</span> serial_length <span style=color:#f92672>&amp;</span> <span style=color:#ae81ff>0xFF</span>;
</span></span><span style=display:flex><span>    buffer[<span style=color:#ae81ff>2</span>] <span style=color:#f92672>=</span> (serial_length <span style=color:#f92672>&gt;&gt;</span> <span style=color:#ae81ff>8</span>) <span style=color:#f92672>&amp;</span> <span style=color:#ae81ff>0xFF</span>;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>memcpy</span>(buffer <span style=color:#f92672>+</span> <span style=color:#ae81ff>3</span>, serial, serial_length); 
</span></span><span style=display:flex><span>    retval <span style=color:#f92672>=</span> <span style=color:#a6e22e>write</span>(fd, buffer, <span style=color:#ae81ff>3</span> <span style=color:#f92672>+</span> serial_length);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>free</span>(buffer);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> retval;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>read_serial</span>(<span style=color:#66d9ef>int</span> fd, <span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span> buffer) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>char</span> size[<span style=color:#ae81ff>2</span>];
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>int</span> serial_length;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>read</span>(fd, size, <span style=color:#ae81ff>2</span>) <span style=color:#f92672>==</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;read error</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>exit</span>(<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    serial_length <span style=color:#f92672>=</span> size[<span style=color:#ae81ff>0</span>] <span style=color:#f92672>|</span> (size[<span style=color:#ae81ff>1</span>] <span style=color:#f92672>&lt;&lt;</span> <span style=color:#ae81ff>8</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>read</span>(fd, buffer, serial_length) <span style=color:#f92672>==</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;read error</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>exit</span>(<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> serial_length;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>ssize_t</span> <span style=color:#a6e22e>probe_child_status</span>(<span style=color:#66d9ef>int</span> fd) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>write</span>(fd, <span style=color:#e6db74>&#34;P&#34;</span>, <span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>ssize_t</span> <span style=color:#a6e22e>probe_response</span>(<span style=color:#66d9ef>int</span> fd, <span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>char</span> cellNumber) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>ssize_t</span> retval;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>char</span> buffer[<span style=color:#ae81ff>2</span>];
</span></span><span style=display:flex><span>    buffer[<span style=color:#ae81ff>0</span>] <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;R&#39;</span>;
</span></span><span style=display:flex><span>    buffer[<span style=color:#ae81ff>1</span>] <span style=color:#f92672>=</span> cellNumber;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>write</span>(fd, buffer, <span style=color:#ae81ff>2</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>ssize_t</span> <span style=color:#a6e22e>send_old_cell_number</span>(<span style=color:#66d9ef>int</span> fd, <span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>char</span> oldCellNumber) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>ssize_t</span> retval;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>char</span> buffer[<span style=color:#ae81ff>2</span>];
</span></span><span style=display:flex><span>    buffer[<span style=color:#ae81ff>0</span>] <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;C&#39;</span>;
</span></span><span style=display:flex><span>    buffer[<span style=color:#ae81ff>1</span>] <span style=color:#f92672>=</span> oldCellNumber;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>write</span>(fd, buffer, <span style=color:#ae81ff>2</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>ssize_t</span> <span style=color:#a6e22e>acknowledge</span>(<span style=color:#66d9ef>int</span> fd) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>write</span>(fd, <span style=color:#e6db74>&#34;A&#34;</span>, <span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>ssize_t</span> <span style=color:#a6e22e>ask_master_for_verification</span>(<span style=color:#66d9ef>int</span> fd) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>write</span>(fd, <span style=color:#e6db74>&#34;V&#34;</span>, <span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>probe_children_status</span>(<span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>char</span> state[]) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Send probe &#39;P&#39; to all children to check if they are alive
</span></span></span><span style=display:flex><span>    <span style=color:#75715e>// If state is not NULL, sequentially construct the state matrix from their cell numbers
</span></span></span><span style=display:flex><span>    fd_set probed_children_read_fds;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>char</span> probed_cell_number;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Also have a timeout on getting a child&#39;s probe response because there&#39;s a chance they killed themselves        
</span></span></span><span style=display:flex><span>    <span style=color:#66d9ef>struct</span> timeval timeout;
</span></span><span style=display:flex><span>    timeout.tv_sec <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>; timeout.tv_usec <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> k <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; k <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>4</span>; k<span style=color:#f92672>++</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> l <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; l <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>4</span>; l<span style=color:#f92672>++</span>) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>probe_child_status</span>(S[<span style=color:#ae81ff>16</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>4</span> <span style=color:#f92672>*</span> k <span style=color:#f92672>+</span> l]) <span style=color:#f92672>==</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>) {
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;write error</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>kill_children</span>();
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>exit</span>(<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>FD_ZERO</span>(<span style=color:#f92672>&amp;</span>probed_children_read_fds);
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>FD_SET</span>(R[<span style=color:#ae81ff>16</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>1</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>4</span> <span style=color:#f92672>*</span> k <span style=color:#f92672>+</span> l], <span style=color:#f92672>&amp;</span>probed_children_read_fds);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>switch</span> (<span style=color:#a6e22e>select</span>(R[<span style=color:#ae81ff>16</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>1</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>4</span> <span style=color:#f92672>*</span> k <span style=color:#f92672>+</span> l] <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>, <span style=color:#f92672>&amp;</span>probed_children_read_fds, NULL, NULL, <span style=color:#f92672>&amp;</span>timeout)) {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>case</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>                    <span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;select error</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>                    <span style=color:#a6e22e>kill_children</span>();
</span></span><span style=display:flex><span>                    <span style=color:#a6e22e>exit</span>(<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>case</span> <span style=color:#ae81ff>0</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>                    <span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;I lost my child :(</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>                    <span style=color:#a6e22e>kill_children</span>();
</span></span><span style=display:flex><span>                    <span style=color:#a6e22e>exit</span>(<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>default</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>read_header_master</span>(R[<span style=color:#ae81ff>16</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>1</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>4</span> <span style=color:#f92672>*</span> k <span style=color:#f92672>+</span> l]) <span style=color:#f92672>!=</span> <span style=color:#e6db74>&#39;R&#39;</span>) {
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;malformed data</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>exit</span>(<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>read</span>(R[<span style=color:#ae81ff>16</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>1</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>4</span> <span style=color:#f92672>*</span> k <span style=color:#f92672>+</span> l], <span style=color:#f92672>&amp;</span>probed_cell_number, <span style=color:#ae81ff>1</span>) <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;read error</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>kill_children</span>();
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>exit</span>(<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (state <span style=color:#f92672>==</span> NULL) {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>continue</span>;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (probed_cell_number <span style=color:#f92672>&gt;=</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>&amp;&amp;</span> probed_cell_number <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>16</span>) {
</span></span><span style=display:flex><span>                state[<span style=color:#ae81ff>4</span> <span style=color:#f92672>*</span> k <span style=color:#f92672>+</span> l] <span style=color:#f92672>=</span> probed_cell_number;
</span></span><span style=display:flex><span>            } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;malformed data</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>kill_children</span>();
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>exit</span>(<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>child_loop</span>(<span style=color:#66d9ef>int</span> x, <span style=color:#66d9ef>int</span> y) {
</span></span><span style=display:flex><span>    fd_set read_fds;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> maxfd, dx, dy;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>char</span> buffer[<span style=color:#ae81ff>2048</span>];
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>ssize_t</span> bytes_read;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>int</span> serial_length;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>char</span> msgType;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>struct</span> timeval timeout, timeout_long;
</span></span><span style=display:flex><span>    timeout.tv_sec <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>; timeout.tv_usec <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>    timeout_long.tv_sec <span style=color:#f92672>=</span> <span style=color:#ae81ff>30</span>; timeout_long.tv_usec <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span> (<span style=color:#ae81ff>1</span>) {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Wait for data from an adjacent pipe or master
</span></span></span><span style=display:flex><span>        <span style=color:#a6e22e>FD_ZERO</span>(<span style=color:#f92672>&amp;</span>read_fds);
</span></span><span style=display:flex><span>        maxfd <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> (dx <span style=color:#f92672>=</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>; dx <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>1</span>; dx<span style=color:#f92672>++</span>) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>for</span> (dy <span style=color:#f92672>=</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>; dy <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>1</span>; dy<span style=color:#f92672>++</span>) {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> ((dx <span style=color:#f92672>&amp;&amp;</span> dy) <span style=color:#f92672>||</span> (dx <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>&amp;&amp;</span> dy <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>)) <span style=color:#66d9ef>continue</span>;
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> (x <span style=color:#f92672>+</span> dx <span style=color:#f92672>&gt;=</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>&amp;&amp;</span> x <span style=color:#f92672>+</span> dx <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>3</span> <span style=color:#f92672>&amp;&amp;</span> y <span style=color:#f92672>+</span> dy <span style=color:#f92672>&gt;=</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>&amp;&amp;</span> y <span style=color:#f92672>+</span> dy <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>3</span>) {
</span></span><span style=display:flex><span>                    <span style=color:#a6e22e>FD_SET</span>(P[<span style=color:#ae81ff>64</span> <span style=color:#f92672>*</span> (x <span style=color:#f92672>+</span> dx) <span style=color:#f92672>+</span> <span style=color:#ae81ff>16</span> <span style=color:#f92672>*</span> (y <span style=color:#f92672>+</span> dy) <span style=color:#f92672>+</span> <span style=color:#ae81ff>4</span> <span style=color:#f92672>*</span> x <span style=color:#f92672>+</span> y], <span style=color:#f92672>&amp;</span>read_fds);
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>if</span> (P[<span style=color:#ae81ff>64</span> <span style=color:#f92672>*</span> (x <span style=color:#f92672>+</span> dx) <span style=color:#f92672>+</span> <span style=color:#ae81ff>16</span> <span style=color:#f92672>*</span> (y <span style=color:#f92672>+</span> dy) <span style=color:#f92672>+</span> <span style=color:#ae81ff>4</span> <span style=color:#f92672>*</span> x <span style=color:#f92672>+</span> y] <span style=color:#f92672>&gt;</span> maxfd)
</span></span><span style=display:flex><span>                        maxfd <span style=color:#f92672>=</span> P[<span style=color:#ae81ff>64</span> <span style=color:#f92672>*</span> (x <span style=color:#f92672>+</span> dx) <span style=color:#f92672>+</span> <span style=color:#ae81ff>16</span> <span style=color:#f92672>*</span> (y <span style=color:#f92672>+</span> dy) <span style=color:#f92672>+</span> <span style=color:#ae81ff>4</span> <span style=color:#f92672>*</span> x <span style=color:#f92672>+</span> y];
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>FD_SET</span>(R[<span style=color:#ae81ff>16</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>4</span> <span style=color:#f92672>*</span> x <span style=color:#f92672>+</span> y], <span style=color:#f92672>&amp;</span>read_fds);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (R[<span style=color:#ae81ff>16</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>4</span> <span style=color:#f92672>*</span> x <span style=color:#f92672>+</span> y] <span style=color:#f92672>&gt;</span> maxfd)
</span></span><span style=display:flex><span>            maxfd <span style=color:#f92672>=</span> R[<span style=color:#ae81ff>16</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>4</span> <span style=color:#f92672>*</span> x <span style=color:#f92672>+</span> y];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>switch</span> (<span style=color:#a6e22e>select</span>(maxfd <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>, <span style=color:#f92672>&amp;</span>read_fds, NULL, NULL, <span style=color:#f92672>&amp;</span>timeout_long)) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;select error</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>exit</span>(<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> <span style=color:#ae81ff>0</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>                <span style=color:#75715e>// Long timeout, consider master as long dead. Silently exit.
</span></span></span><span style=display:flex><span>                <span style=color:#a6e22e>exit</span>(<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>default</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Received from master
</span></span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>FD_ISSET</span>(R[<span style=color:#ae81ff>16</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>4</span> <span style=color:#f92672>*</span> x <span style=color:#f92672>+</span> y], <span style=color:#f92672>&amp;</span>read_fds)) {
</span></span><span style=display:flex><span>            msgType <span style=color:#f92672>=</span> <span style=color:#a6e22e>read_header</span>(R[<span style=color:#ae81ff>16</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>4</span> <span style=color:#f92672>*</span> x <span style=color:#f92672>+</span> y]);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>#ifdef DEBUG
</span></span></span><span style=display:flex><span>            <span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;[%d,%d] Received from master: %c</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, x, y, msgType);
</span></span><span style=display:flex><span>            <span style=color:#75715e>#endif
</span></span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (msgType <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;P&#39;</span>) {
</span></span><span style=display:flex><span>                <span style=color:#75715e>// Probe child status
</span></span></span><span style=display:flex><span>                <span style=color:#75715e>// Send cell number back to master
</span></span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>probe_response</span>(S[<span style=color:#ae81ff>16</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>1</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>4</span> <span style=color:#f92672>*</span> x <span style=color:#f92672>+</span> y], cell_number) <span style=color:#f92672>==</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>) {
</span></span><span style=display:flex><span>                    <span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;write error</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>                    <span style=color:#a6e22e>exit</span>(<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            } <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (msgType <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;S&#39;</span>) {
</span></span><span style=display:flex><span>                <span style=color:#75715e>// Received the whole serial (starting cell), send it to next cell
</span></span></span><span style=display:flex><span>                serial_length <span style=color:#f92672>=</span> <span style=color:#a6e22e>read_serial</span>(R[<span style=color:#ae81ff>16</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>4</span> <span style=color:#f92672>*</span> x <span style=color:#f92672>+</span> y], buffer);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#75715e>#ifdef DEBUG
</span></span></span><span style=display:flex><span>                <span style=color:#a6e22e>debug_print_serial</span>(buffer, serial_length);
</span></span><span style=display:flex><span>                <span style=color:#75715e>#endif
</span></span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>convert_move</span>(buffer[<span style=color:#ae81ff>0</span>], <span style=color:#f92672>&amp;</span>dx, <span style=color:#f92672>&amp;</span>dy);
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> (x <span style=color:#f92672>+</span> dx <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>||</span> x <span style=color:#f92672>+</span> dx <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>3</span> <span style=color:#f92672>||</span> y <span style=color:#f92672>+</span> dy <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>||</span> y <span style=color:#f92672>+</span> dy <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>3</span>) {
</span></span><span style=display:flex><span>                    <span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;You lost your path already?</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>                    <span style=color:#a6e22e>exit</span>(<span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>send_serial</span>(Q[<span style=color:#ae81ff>64</span> <span style=color:#f92672>*</span> x <span style=color:#f92672>+</span> <span style=color:#ae81ff>16</span> <span style=color:#f92672>*</span> y <span style=color:#f92672>+</span> <span style=color:#ae81ff>4</span> <span style=color:#f92672>*</span> (x <span style=color:#f92672>+</span> dx) <span style=color:#f92672>+</span> (y <span style=color:#f92672>+</span> dy)], buffer <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>, serial_length <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>) <span style=color:#f92672>==</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>) {
</span></span><span style=display:flex><span>                    <span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;write error</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>                    <span style=color:#a6e22e>exit</span>(<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;malformed data</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>exit</span>(<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>            <span style=color:#75715e>// Find which adjacent cell sent the remaining serial
</span></span></span><span style=display:flex><span>            <span style=color:#66d9ef>for</span> (dx <span style=color:#f92672>=</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>; dx <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>1</span>; dx<span style=color:#f92672>++</span>) {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>for</span> (dy <span style=color:#f92672>=</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>; dy <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>1</span>; dy<span style=color:#f92672>++</span>) {
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>if</span> ((dx <span style=color:#f92672>&amp;&amp;</span> dy) <span style=color:#f92672>||</span> (dx <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>&amp;&amp;</span> dy <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>)) <span style=color:#66d9ef>continue</span>;
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>if</span> (x <span style=color:#f92672>+</span> dx <span style=color:#f92672>&gt;=</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>&amp;&amp;</span> x <span style=color:#f92672>+</span> dx <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>3</span> <span style=color:#f92672>&amp;&amp;</span> y <span style=color:#f92672>+</span> dy <span style=color:#f92672>&gt;=</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>&amp;&amp;</span> y <span style=color:#f92672>+</span> dy <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>3</span>) {
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>FD_ISSET</span>(P[<span style=color:#ae81ff>64</span> <span style=color:#f92672>*</span> (x <span style=color:#f92672>+</span> dx) <span style=color:#f92672>+</span> <span style=color:#ae81ff>16</span> <span style=color:#f92672>*</span> (y <span style=color:#f92672>+</span> dy) <span style=color:#f92672>+</span> <span style=color:#ae81ff>4</span> <span style=color:#f92672>*</span> x <span style=color:#f92672>+</span> y], <span style=color:#f92672>&amp;</span>read_fds)) {
</span></span><span style=display:flex><span>                            <span style=color:#66d9ef>goto</span> found_adjacent_cell;
</span></span><span style=display:flex><span>                        }
</span></span><span style=display:flex><span>                    }
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            found_adjacent_cell:                
</span></span><span style=display:flex><span>            msgType <span style=color:#f92672>=</span> <span style=color:#a6e22e>read_header</span>(P[<span style=color:#ae81ff>64</span> <span style=color:#f92672>*</span> (x <span style=color:#f92672>+</span> dx) <span style=color:#f92672>+</span> <span style=color:#ae81ff>16</span> <span style=color:#f92672>*</span> (y <span style=color:#f92672>+</span> dy) <span style=color:#f92672>+</span> <span style=color:#ae81ff>4</span> <span style=color:#f92672>*</span> x <span style=color:#f92672>+</span> y]);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>#ifdef DEBUG
</span></span></span><span style=display:flex><span>            <span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;[%d,%d] Received from adjacent cell (%d, %d): %c</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, x, y, x <span style=color:#f92672>+</span> dx, y <span style=color:#f92672>+</span> dy, msgType);
</span></span><span style=display:flex><span>            <span style=color:#75715e>#endif
</span></span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (msgType <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;C&#39;</span>) {
</span></span><span style=display:flex><span>                <span style=color:#75715e>// Change cell number
</span></span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>read</span>(P[<span style=color:#ae81ff>64</span> <span style=color:#f92672>*</span> (x <span style=color:#f92672>+</span> dx) <span style=color:#f92672>+</span> <span style=color:#ae81ff>16</span> <span style=color:#f92672>*</span> (y <span style=color:#f92672>+</span> dy) <span style=color:#f92672>+</span> <span style=color:#ae81ff>4</span> <span style=color:#f92672>*</span> x <span style=color:#f92672>+</span> y], <span style=color:#f92672>&amp;</span>cell_number, <span style=color:#ae81ff>1</span>) <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>                    <span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;read error</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>                    <span style=color:#a6e22e>exit</span>(<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> (cell_number <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>||</span> cell_number <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>15</span>) {
</span></span><span style=display:flex><span>                    <span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;malformed data</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>                    <span style=color:#a6e22e>exit</span>(<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#75715e>#ifdef DEBUG
</span></span></span><span style=display:flex><span>                <span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;[%d,%d] My new cell number is %d</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, x, y, (<span style=color:#66d9ef>int</span>)cell_number);
</span></span><span style=display:flex><span>                <span style=color:#75715e>#endif
</span></span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#75715e>// Acknowledge
</span></span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>acknowledge</span>(Q[<span style=color:#ae81ff>64</span> <span style=color:#f92672>*</span> x <span style=color:#f92672>+</span> <span style=color:#ae81ff>16</span> <span style=color:#f92672>*</span> y <span style=color:#f92672>+</span> <span style=color:#ae81ff>4</span> <span style=color:#f92672>*</span> (x <span style=color:#f92672>+</span> dx) <span style=color:#f92672>+</span> (y <span style=color:#f92672>+</span> dy)]) <span style=color:#f92672>==</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>) {
</span></span><span style=display:flex><span>                    <span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;write error</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>                    <span style=color:#a6e22e>exit</span>(<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>                };
</span></span><span style=display:flex><span>            } <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (msgType <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;S&#39;</span>) {
</span></span><span style=display:flex><span>                <span style=color:#75715e>// Received remaining serial
</span></span></span><span style=display:flex><span>                serial_length <span style=color:#f92672>=</span> <span style=color:#a6e22e>read_serial</span>(P[<span style=color:#ae81ff>64</span> <span style=color:#f92672>*</span> (x <span style=color:#f92672>+</span> dx) <span style=color:#f92672>+</span> <span style=color:#ae81ff>16</span> <span style=color:#f92672>*</span> (y <span style=color:#f92672>+</span> dy) <span style=color:#f92672>+</span> <span style=color:#ae81ff>4</span> <span style=color:#f92672>*</span> x <span style=color:#f92672>+</span> y], buffer);
</span></span><span style=display:flex><span>                <span style=color:#75715e>#ifdef DEBUG
</span></span></span><span style=display:flex><span>                <span style=color:#a6e22e>debug_print_serial</span>(buffer, serial_length);
</span></span><span style=display:flex><span>                <span style=color:#75715e>#endif
</span></span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#75715e>// Send old cell number back to adjacent cell
</span></span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>send_old_cell_number</span>(Q[<span style=color:#ae81ff>64</span> <span style=color:#f92672>*</span> x <span style=color:#f92672>+</span> <span style=color:#ae81ff>16</span> <span style=color:#f92672>*</span> y <span style=color:#f92672>+</span> <span style=color:#ae81ff>4</span> <span style=color:#f92672>*</span> (x <span style=color:#f92672>+</span> dx) <span style=color:#f92672>+</span> (y <span style=color:#f92672>+</span> dy)], cell_number) <span style=color:#f92672>==</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>) {
</span></span><span style=display:flex><span>                    <span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;write error</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>                    <span style=color:#a6e22e>exit</span>(<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#75715e>// We are now the hole
</span></span></span><span style=display:flex><span>                cell_number <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#75715e>// Wait for acknowledgement to pursue
</span></span></span><span style=display:flex><span>                fd_set adjacent_cell_read_fds;
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>FD_ZERO</span>(<span style=color:#f92672>&amp;</span>adjacent_cell_read_fds);
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>FD_SET</span>(P[<span style=color:#ae81ff>64</span> <span style=color:#f92672>*</span> (x <span style=color:#f92672>+</span> dx) <span style=color:#f92672>+</span> <span style=color:#ae81ff>16</span> <span style=color:#f92672>*</span> (y <span style=color:#f92672>+</span> dy) <span style=color:#f92672>+</span> <span style=color:#ae81ff>4</span> <span style=color:#f92672>*</span> x <span style=color:#f92672>+</span> y], <span style=color:#f92672>&amp;</span>adjacent_cell_read_fds);
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>switch</span> (<span style=color:#a6e22e>select</span>(P[<span style=color:#ae81ff>64</span> <span style=color:#f92672>*</span> (x <span style=color:#f92672>+</span> dx) <span style=color:#f92672>+</span> <span style=color:#ae81ff>16</span> <span style=color:#f92672>*</span> (y <span style=color:#f92672>+</span> dy) <span style=color:#f92672>+</span> <span style=color:#ae81ff>4</span> <span style=color:#f92672>*</span> x <span style=color:#f92672>+</span> y] <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>, <span style=color:#f92672>&amp;</span>adjacent_cell_read_fds, NULL, NULL, <span style=color:#f92672>&amp;</span>timeout)) {
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>case</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>                        <span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;select error</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>                        <span style=color:#a6e22e>exit</span>(<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>case</span> <span style=color:#ae81ff>0</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>                        <span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;I lost my brother... why bother anymore?</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>                        <span style=color:#a6e22e>exit</span>(<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>default</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                msgType <span style=color:#f92672>=</span> <span style=color:#a6e22e>read_header</span>(P[<span style=color:#ae81ff>64</span> <span style=color:#f92672>*</span> (x <span style=color:#f92672>+</span> dx) <span style=color:#f92672>+</span> <span style=color:#ae81ff>16</span> <span style=color:#f92672>*</span> (y <span style=color:#f92672>+</span> dy) <span style=color:#f92672>+</span> <span style=color:#ae81ff>4</span> <span style=color:#f92672>*</span> x <span style=color:#f92672>+</span> y]);
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> (msgType <span style=color:#f92672>!=</span> <span style=color:#e6db74>&#39;A&#39;</span>) {
</span></span><span style=display:flex><span>                    <span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;malformed data</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>                    <span style=color:#a6e22e>exit</span>(<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#75715e>#ifdef DEBUG
</span></span></span><span style=display:flex><span>                <span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;[%d,%d] Received ack from (%d, %d)</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, x, y, x <span style=color:#f92672>+</span> dx, y <span style=color:#f92672>+</span> dy);
</span></span><span style=display:flex><span>                <span style=color:#75715e>#endif
</span></span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#75715e>// If no more moves (null serial length), ask master for verification
</span></span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> (serial_length <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>ask_master_for_verification</span>(S[<span style=color:#ae81ff>16</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>1</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>4</span> <span style=color:#f92672>*</span> x <span style=color:#f92672>+</span> y]) <span style=color:#f92672>==</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>) {
</span></span><span style=display:flex><span>                        <span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;write error</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>                        <span style=color:#a6e22e>exit</span>(<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>                    }
</span></span><span style=display:flex><span>                } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>                    <span style=color:#75715e>// Send remaining serial to next cell
</span></span></span><span style=display:flex><span>                    <span style=color:#a6e22e>convert_move</span>(buffer[<span style=color:#ae81ff>0</span>], <span style=color:#f92672>&amp;</span>dx, <span style=color:#f92672>&amp;</span>dy);
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>if</span> (x <span style=color:#f92672>+</span> dx <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>||</span> x <span style=color:#f92672>+</span> dx <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>3</span> <span style=color:#f92672>||</span> y <span style=color:#f92672>+</span> dy <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>||</span> y <span style=color:#f92672>+</span> dy <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>3</span>) {
</span></span><span style=display:flex><span>                        <span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;You lost your path and fell into lava. It hurts and you die.</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>                        <span style=color:#a6e22e>exit</span>(<span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>                    }
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>send_serial</span>(Q[<span style=color:#ae81ff>64</span> <span style=color:#f92672>*</span> x <span style=color:#f92672>+</span> <span style=color:#ae81ff>16</span> <span style=color:#f92672>*</span> y <span style=color:#f92672>+</span> <span style=color:#ae81ff>4</span> <span style=color:#f92672>*</span> (x <span style=color:#f92672>+</span> dx) <span style=color:#f92672>+</span> (y <span style=color:#f92672>+</span> dy)], buffer <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>, serial_length <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>) <span style=color:#f92672>==</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>) {
</span></span><span style=display:flex><span>                        <span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;write error</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>                        <span style=color:#a6e22e>exit</span>(<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>                    }
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;malformed data</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>exit</span>(<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>master_loop</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>char</span> msgType;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> maxfd;
</span></span><span style=display:flex><span>    fd_set read_fds;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>char</span> state[<span style=color:#ae81ff>16</span>];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>struct</span> timeval timeout, timeout_long;
</span></span><span style=display:flex><span>    timeout.tv_sec <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>; timeout.tv_usec <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span> (<span style=color:#ae81ff>1</span>) {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Periodically probe children status
</span></span></span><span style=display:flex><span>        <span style=color:#a6e22e>probe_children_status</span>(NULL);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Wait for data from any child
</span></span></span><span style=display:flex><span>        <span style=color:#a6e22e>FD_ZERO</span>(<span style=color:#f92672>&amp;</span>read_fds);
</span></span><span style=display:flex><span>        maxfd <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>int</span> i, j;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> (i <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; i <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>4</span>; i<span style=color:#f92672>++</span>) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>for</span> (j <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; j <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>4</span>; j<span style=color:#f92672>++</span>) {
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>FD_SET</span>(R[<span style=color:#ae81ff>16</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>1</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>4</span> <span style=color:#f92672>*</span> i <span style=color:#f92672>+</span> j], <span style=color:#f92672>&amp;</span>read_fds);
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> (R[<span style=color:#ae81ff>16</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>1</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>4</span> <span style=color:#f92672>*</span> i <span style=color:#f92672>+</span> j] <span style=color:#f92672>&gt;</span> maxfd)
</span></span><span style=display:flex><span>                    maxfd <span style=color:#f92672>=</span> R[<span style=color:#ae81ff>16</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>1</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>4</span> <span style=color:#f92672>*</span> i <span style=color:#f92672>+</span> j];
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>switch</span> (<span style=color:#a6e22e>select</span>(maxfd <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>, <span style=color:#f92672>&amp;</span>read_fds, NULL, NULL, <span style=color:#f92672>&amp;</span>timeout)) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;select error</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>exit</span>(<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> <span style=color:#ae81ff>0</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>                <span style=color:#75715e>// Timeout: no data available, just loop
</span></span></span><span style=display:flex><span>                <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>default</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>                <span style=color:#75715e>// Data available from a child
</span></span></span><span style=display:flex><span>                <span style=color:#66d9ef>goto</span> data_available_from_child;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>continue</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        data_available_from_child:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Find child that sent data
</span></span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> (i <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; i <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>4</span>; i<span style=color:#f92672>++</span>) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>for</span> (j <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; j <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>4</span>; j<span style=color:#f92672>++</span>) {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>FD_ISSET</span>(R[<span style=color:#ae81ff>16</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>1</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>4</span> <span style=color:#f92672>*</span> i <span style=color:#f92672>+</span> j], <span style=color:#f92672>&amp;</span>read_fds)) {
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>goto</span> found_child;
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        found_child:
</span></span><span style=display:flex><span>        msgType <span style=color:#f92672>=</span> <span style=color:#a6e22e>read_header_master</span>(R[<span style=color:#ae81ff>16</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>1</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>4</span> <span style=color:#f92672>*</span> i <span style=color:#f92672>+</span> j]);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (msgType <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;V&#39;</span>) {
</span></span><span style=display:flex><span>            <span style=color:#75715e>// Child asked for verification
</span></span></span><span style=display:flex><span>            <span style=color:#75715e>// Reprobe everyone and construct state matrix
</span></span></span><span style=display:flex><span>            <span style=color:#a6e22e>memset</span>(state, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>16</span>);
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>probe_children_status</span>(state);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>#ifdef DEBUG
</span></span></span><span style=display:flex><span>            <span style=color:#75715e>// Display board state (debug)
</span></span></span><span style=display:flex><span>            <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; i <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>4</span>; i<span style=color:#f92672>++</span>) {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> j <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; j <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>4</span>; j<span style=color:#f92672>++</span>) {
</span></span><span style=display:flex><span>                    <span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;%d &#34;</span>, (<span style=color:#66d9ef>int</span>)state[<span style=color:#ae81ff>4</span> <span style=color:#f92672>*</span> i <span style=color:#f92672>+</span> j]);
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>            <span style=color:#75715e>#endif
</span></span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// Check if instance is solved
</span></span></span><span style=display:flex><span>            <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> k <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; k <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>4</span>; k<span style=color:#f92672>++</span>) {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> l <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; l <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>4</span>; l<span style=color:#f92672>++</span>) {
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>if</span> (state[<span style=color:#ae81ff>4</span> <span style=color:#f92672>*</span> k <span style=color:#f92672>+</span> l] <span style=color:#f92672>!=</span> <span style=color:#ae81ff>4</span> <span style=color:#f92672>*</span> k <span style=color:#f92672>+</span> l) {
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>goto</span> bad_boy;
</span></span><span style=display:flex><span>                    }
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;That&#39;s pretty good!</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>kill_children</span>();
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>exit</span>(<span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            bad_boy:
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;You failed really hard. At least you managed to survive...</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>kill_children</span>();
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>exit</span>(<span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;malformed data</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>kill_children</span>();
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>exit</span>(<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#ifdef DEBUG
</span></span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>debug_print_serial</span>(<span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span> buffer, <span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>int</span> serial_length) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;Serial : &#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; i <span style=color:#f92672>&lt;</span> serial_length; i<span style=color:#f92672>++</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;%u &#34;</span>, (<span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>int</span>)buffer[i]);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#75715e>#endif
</span></span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span>(<span style=color:#66d9ef>int</span> argc, <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span> argv[]) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>char</span> msgType;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>char</span> username[<span style=color:#ae81ff>512</span>];
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>int</span> username_crc <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>char</span> hex_serial[<span style=color:#ae81ff>512</span>];
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>char</span> serial[<span style=color:#ae81ff>2048</span>];
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>int</span> serial_length;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>char</span> initial_state[] <span style=color:#f92672>=</span> { <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>3</span>, <span style=color:#ae81ff>4</span>, <span style=color:#ae81ff>5</span>, <span style=color:#ae81ff>6</span>, <span style=color:#ae81ff>7</span>, <span style=color:#ae81ff>8</span>, <span style=color:#ae81ff>9</span>, <span style=color:#ae81ff>10</span>, <span style=color:#ae81ff>11</span>, <span style=color:#ae81ff>12</span>, <span style=color:#ae81ff>13</span>, <span style=color:#ae81ff>14</span>, <span style=color:#ae81ff>15</span> };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;Enter username: &#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>scanf</span>(<span style=color:#e6db74>&#34;%511s&#34;</span>, username);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>crc32</span>(username, <span style=color:#a6e22e>strlen</span>(username), <span style=color:#f92672>&amp;</span>username_crc);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>my_srand</span>(username_crc);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>fisher_yates_shuffle</span>(initial_state, <span style=color:#ae81ff>16</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>#ifdef DEBUG
</span></span></span><span style=display:flex><span>    <span style=color:#75715e>// Display initial board state (debug)
</span></span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; i <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>4</span>; i<span style=color:#f92672>++</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> j <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; j <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>4</span>; j<span style=color:#f92672>++</span>) {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;%d &#34;</span>, (<span style=color:#66d9ef>int</span>)initial_state[<span style=color:#ae81ff>4</span> <span style=color:#f92672>*</span> i <span style=color:#f92672>+</span> j]);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#75715e>#endif
</span></span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>initialize_pipes</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>pid_t</span> pid;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> x, y;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> (x <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; x <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>4</span>; x<span style=color:#f92672>++</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> (y <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; y <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>4</span>; y<span style=color:#f92672>++</span>) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> ((pid <span style=color:#f92672>=</span> <span style=color:#a6e22e>fork</span>()) <span style=color:#f92672>==</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>) {
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;fork failed</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>exit</span>(<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (pid <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>goto</span> out_fork_loop;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    out_fork_loop:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (pid <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Child process (x, y)
</span></span></span><span style=display:flex><span>        cell_number <span style=color:#f92672>=</span> initial_state[<span style=color:#ae81ff>4</span> <span style=color:#f92672>*</span> x <span style=color:#f92672>+</span> y];
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>child_loop</span>(x, y);
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Master process
</span></span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>setsid</span>(); <span style=color:#75715e>// Make the master process the group leader if it&#39;s not already
</span></span></span><span style=display:flex><span>        pgid <span style=color:#f92672>=</span> <span style=color:#a6e22e>getpgid</span>(pid); <span style=color:#75715e>// Process group of child processes
</span></span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Cleanly kill children on CTRL+C
</span></span></span><span style=display:flex><span>        <span style=color:#66d9ef>struct</span> sigaction act;
</span></span><span style=display:flex><span>        act.sa_handler <span style=color:#f92672>=</span> handle_int;
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>sigaction</span>(SIGINT, <span style=color:#f92672>&amp;</span>act, NULL);  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;Enter serial: &#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>scanf</span>(<span style=color:#e6db74>&#34;%511s&#34;</span>, hex_serial);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>hex_to_base4</span>(hex_serial, serial);
</span></span><span style=display:flex><span>        serial_length <span style=color:#f92672>=</span> <span style=color:#ae81ff>2</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>strlen</span>(hex_serial);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (serial_length <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>1</span>) {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;Serial is too short!</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>kill_children</span>();
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>exit</span>(<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>/*
</span></span></span><span style=display:flex><span><span style=color:#75715e>        printf(&#34;Base4 conversion result: &#34;);
</span></span></span><span style=display:flex><span><span style=color:#75715e>        for (int i = 0; i &lt; serial_length; i++) {
</span></span></span><span style=display:flex><span><span style=color:#75715e>            printf(&#34;%d &#34;, (int)serial[i]);
</span></span></span><span style=display:flex><span><span style=color:#75715e>        }
</span></span></span><span style=display:flex><span><span style=color:#75715e>        printf(&#34;\n&#34;);
</span></span></span><span style=display:flex><span><span style=color:#75715e>        */</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Find the &#34;hole&#34; process (cell_number=0)
</span></span></span><span style=display:flex><span>        <span style=color:#66d9ef>int</span> i, j;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> (i <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; i <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>4</span>; i<span style=color:#f92672>++</span>) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>for</span> (j <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; j <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>4</span>; j<span style=color:#f92672>++</span>) {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> (initial_state[<span style=color:#ae81ff>4</span> <span style=color:#f92672>*</span> i <span style=color:#f92672>+</span> j] <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>goto</span> found_hole;
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        found_hole:
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Send the serial to the hole process (i, j)
</span></span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>send_serial</span>(S[<span style=color:#ae81ff>16</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>4</span> <span style=color:#f92672>*</span> i <span style=color:#f92672>+</span> j], serial, serial_length) <span style=color:#f92672>==</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>) {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;write error</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>kill_children</span>();
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>exit</span>(<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>master_loop</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button previous"><a href=/posts/patching-steam-binaries/><span class=button__icon>â†</span>
<span class=button__text>Patching Steam binaries</span></a></span></div></div></div></div><footer class=footer><div class=footer__inner><a href=/ class=logo style=text-decoration:none><span class=logo__mark><svg class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg>
</span><span class=logo__text>face@0xff</span>
<span class=logo__cursor></span></a><div class=copyright><span>Â© 2026 Powered by
<a href=https://gohugo.io target=_blank rel=noopener>Hugo</a></span>
<span>Theme created by
<a href=https://twitter.com/panr target=_blank rel=noopener>panr</a></span></div></div></footer><script src=/assets/main.js></script><script src=/assets/prism.js></script><script type=text/javascript src=/js/custom.js></script></div></body></html>